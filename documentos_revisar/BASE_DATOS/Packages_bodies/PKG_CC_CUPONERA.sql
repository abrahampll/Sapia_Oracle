CREATE OR REPLACE PACKAGE BODY PCLUB.PKG_CC_CUPONERA AS
/******************************************************************************
   NAME:       PCLUB.PKG_CC_CUPONERA
   PURPOSE:

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        10/08/2012      E77210 - JCGT      1. Created this package.
******************************************************************************/


  PROCEDURE ADMPSI_ALTACLIENTEDIARIO(K_TIPODOC IN VARCHAR2,K_NUMDOC IN VARCHAR2,K_NOMCLI IN VARCHAR2,K_APECLI IN VARCHAR2,K_EMAIL IN VARCHAR2,
                                                     K_ORIGEN  IN VARCHAR2,K_USUARIO IN VARCHAR2, K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS

V_CONT  NUMBER;
--V_COD_CLI VARCHAR2(40);
V_COD_SEG VARCHAR2(2);
V_SEG NUMBER;
EX_ERROR EXCEPTION;
BEGIN
 K_CODERROR  := 0;
 K_DESCERROR := '';

    BEGIN
        SELECT ADMPV_VALOR INTO V_COD_SEG
        FROM PCLUB.ADMPT_PARAMSIST
        WHERE ADMPV_DESC='SEGMENTO_CUPONERA_INICIAL';
    EXCEPTION
        WHEN OTHERS THEN
             K_CODERROR  := 9;
             K_DESCERROR := ' "SEGMENTO_CUPONERA_INICIAL" . ';
             RAISE EX_ERROR;
    END;

    BEGIN
        SELECT ADMPN_COD_SEG INTO V_SEG
        FROM PCLUB.ADMPT_SEGMENTOCUPONERA
        WHERE ADMPV_DESCRIPCION=V_COD_SEG;
    EXCEPTION
        WHEN OTHERS THEN
             K_CODERROR  := 4;
             K_DESCERROR := ' No  existe el segmento asignado . ';
             RAISE EX_ERROR;
    END;

ADMPSI_ALTACLIENTE(K_TIPODOC,K_NUMDOC,K_NOMCLI,K_APECLI,K_EMAIL,V_SEG,K_ORIGEN,K_USUARIO, K_CODERROR,K_DESCERROR);

EXCEPTION
    WHEN EX_ERROR THEN
             /*INSERT INTO PCLUB.ADMPT_CLIENTECUPONERALOG(ADMPV_TIPO_DOC,ADMPV_NUM_DOC,ADMPV_NOM_CLI,ADMPV_APE_CLI,ADMPV_EMAIL,ADMPC_ESTADO,ADMPD_FEC_REG,ADMPV_USU_REG,ADMPN_COD_SEG,
             ADMPV_ORIGEN,ADMPV_DESC_ERROR) VALUES(K_TIPODOC,K_NUMDOC,K_NOMCLI,K_APECLI,K_EMAIL,'N',SYSDATE,K_USUARIO,V_COD_SEG,K_ORIGEN,K_DESCERROR);
            */
            BEGIN
                    SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                    FROM PCLUB.ADMPT_ERRORES_CC
                    WHERE ADMPN_COD_ERROR=K_CODERROR;
            EXCEPTION WHEN OTHERS THEN
                K_DESCERROR:='ERROR';
            END;

    WHEN OTHERS THEN
             K_CODERROR  := 1;
             K_DESCERROR :=SUBSTR(SQLERRM, 1, 250);
             /*INSERT INTO PCLUB.ADMPT_CLIENTECUPONERALOG(ADMPV_TIPO_DOC,ADMPV_NUM_DOC,ADMPV_NOM_CLI,ADMPV_APE_CLI,ADMPV_EMAIL,ADMPC_ESTADO,ADMPD_FEC_REG,ADMPV_USU_REG,ADMPN_COD_SEG,
             ADMPV_ORIGEN,ADMPV_DESC_ERROR) VALUES(K_TIPODOC,K_NUMDOC,K_NOMCLI,K_APECLI,K_EMAIL,'N',SYSDATE,K_USUARIO,V_COD_SEG,K_ORIGEN,K_DESCERROR);
            COMMIT;*/
END ADMPSI_ALTACLIENTEDIARIO;

  PROCEDURE ADMPSI_ALTACLIENTE(K_TIPODOC IN VARCHAR2,K_NUMDOC IN VARCHAR2,K_NOMCLI IN VARCHAR2,K_APECLI IN VARCHAR2,K_EMAIL IN VARCHAR2,
                                                     K_COD_SEG IN NUMBER,K_ORIGEN  IN VARCHAR2,K_USUARIO IN VARCHAR2, K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS

V_CONT  NUMBER;
--V_COD_CLI VARCHAR2(40);
V_COD_SEG VARCHAR2(2);
EX_ERROR EXCEPTION;
BEGIN
 K_CODERROR  := 0;
 K_DESCERROR := '';

 IF K_TIPODOC IS NULL THEN
     K_CODERROR  := 4;
     K_DESCERROR := 'No ingreso el tipo de Dcto. ';
     RAISE EX_ERROR;
 END IF;

 IF K_NUMDOC IS NULL THEN
     K_CODERROR  := 4;
     K_DESCERROR := 'No ingreso el Nro de Dcto.. ';
     RAISE EX_ERROR;
 END IF;

  IF K_COD_SEG IS NULL THEN
     K_CODERROR  := 4;
     K_DESCERROR := 'No ingreso el Cod. Segmento. ';
     RAISE EX_ERROR;
 END IF;

         SELECT COUNT(K_NUMDOC) INTO V_CONT
         FROM PCLUB.ADMPT_CLIENTECUPONERA C
         WHERE C.ADMPV_NUM_DOC = UPPER(K_NUMDOC)
         AND C.ADMPV_TIPO_DOC = K_TIPODOC
         AND C.ADMPC_ESTADO='A';

 IF V_CONT > 0 THEN
     K_CODERROR  := 4;
     K_DESCERROR := 'El cliente ya se encuentra registrado. ';
     RAISE EX_ERROR;
 END IF;



INSERT INTO PCLUB.ADMPT_CLIENTECUPONERA(ADMPN_COD_CLI,ADMPV_TIPO_DOC,ADMPV_NUM_DOC,ADMPV_NOM_CLI,ADMPV_APE_CLI,ADMPV_EMAIL,ADMPC_ESTADO,ADMPN_COD_SEG,ADMPD_FEC_REG,ADMPV_USU_REG,ADMPV_ESTADO_CON)
VALUES (PCLUB.ADMPT_CLIECUPONERA_SQ.NEXTVAL,K_TIPODOC,UPPER(K_NUMDOC),UPPER(K_NOMCLI),UPPER(K_APECLI),K_EMAIL,'A',K_COD_SEG,SYSDATE,K_USUARIO,'A');

INSERT INTO PCLUB.ADMPT_CLIENTECUPONERALOG(ADMPV_TIPO_DOC,ADMPV_NUM_DOC,ADMPV_NOM_CLI,ADMPV_APE_CLI,ADMPV_EMAIL,ADMPC_ESTADO,ADMPD_FEC_REG,ADMPV_USU_REG,ADMPV_COD_SEG,ADMPV_ORIGEN,ADMPV_PROCESO)
VALUES(K_TIPODOC,UPPER(K_NUMDOC),UPPER(K_NOMCLI),UPPER(K_APECLI),K_EMAIL,'R',SYSDATE,K_USUARIO,V_COD_SEG,K_ORIGEN,'A');


BEGIN
        SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
        FROM PCLUB.ADMPT_ERRORES_CC
        WHERE ADMPN_COD_ERROR=K_CODERROR;
EXCEPTION WHEN OTHERS THEN
    K_DESCERROR:='';
END;

EXCEPTION
    WHEN EX_ERROR THEN

             INSERT INTO PCLUB.ADMPT_CLIENTECUPONERALOG(ADMPV_TIPO_DOC,ADMPV_NUM_DOC,ADMPV_NOM_CLI,ADMPV_APE_CLI,ADMPV_EMAIL,ADMPC_ESTADO,ADMPD_FEC_REG,ADMPV_USU_REG,ADMPV_COD_SEG,
             ADMPV_ORIGEN,ADMPV_DESC_ERROR,ADMPV_PROCESO) VALUES(K_TIPODOC,UPPER(K_NUMDOC),UPPER(K_NOMCLI),UPPER(K_APECLI),K_EMAIL,'N',SYSDATE,K_USUARIO,V_COD_SEG,K_ORIGEN,K_DESCERROR,'A');

            BEGIN
                    SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                    FROM PCLUB.ADMPT_ERRORES_CC
                    WHERE ADMPN_COD_ERROR=K_CODERROR;
            EXCEPTION WHEN OTHERS THEN
                K_DESCERROR:='ERROR';
            END;

    WHEN OTHERS THEN

             K_CODERROR  := 1;
             K_DESCERROR :=SUBSTR(SQLERRM, 1, 250);
             INSERT INTO PCLUB.ADMPT_CLIENTECUPONERALOG(ADMPV_TIPO_DOC,ADMPV_NUM_DOC,ADMPV_NOM_CLI,ADMPV_APE_CLI,ADMPV_EMAIL,ADMPC_ESTADO,ADMPD_FEC_REG,ADMPV_USU_REG,ADMPV_COD_SEG,
             ADMPV_ORIGEN,ADMPV_DESC_ERROR,ADMPV_PROCESO) VALUES(K_TIPODOC,UPPER(K_NUMDOC),UPPER(K_NOMCLI),UPPER(K_APECLI),K_EMAIL,'N',SYSDATE,K_USUARIO,V_COD_SEG,K_ORIGEN,K_DESCERROR,'A');

END ADMPSI_ALTACLIENTE;


PROCEDURE ADMPSI_BAJACLIENTE(K_TIPODOC IN VARCHAR2,K_NUMDOC IN VARCHAR2,K_ORIGEN  IN VARCHAR2,K_USUARIO IN VARCHAR2,K_COD_CLI OUT NUMBER,K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS

V_FLAGFIJA NUMBER;
V_FLAGMOVIL NUMBER;
V_CONT NUMBER;
EX_ERROR EXCEPTION;
BEGIN
    K_CODERROR  := 0;
    K_DESCERROR := '';

     IF K_TIPODOC IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'No ingreso el tipo de Dcto. ';
         RAISE EX_ERROR;
     END IF;

     IF K_NUMDOC IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'No ingreso el Nro de Dcto.. ';
         RAISE EX_ERROR;
     END IF;

        SELECT COUNT(K_NUMDOC) INTO V_CONT
         FROM PCLUB.ADMPT_CLIENTECUPONERA C
         WHERE C.ADMPV_NUM_DOC = UPPER(K_NUMDOC)
         AND C.ADMPV_TIPO_DOC = K_TIPODOC
         AND C.ADMPC_ESTADO='A';

    IF V_CONT = 0 THEN
            K_CODERROR  := 6;
            K_DESCERROR := '';
            RAISE EX_ERROR;
    ELSIF V_CONT = 1 THEN
             SELECT C.ADMPN_COD_CLI INTO K_COD_CLI
             FROM PCLUB.ADMPT_CLIENTECUPONERA C
             WHERE C.ADMPV_NUM_DOC = UPPER(K_NUMDOC)
             AND C.ADMPV_TIPO_DOC = K_TIPODOC
             AND C.ADMPC_ESTADO='A';
    ELSE
             K_CODERROR  := 14;
             K_DESCERROR := '';
             RAISE EX_ERROR;
    END IF;

         SELECT COUNT(*) INTO V_FLAGFIJA
         FROM PCLUB.ADMPT_CLIENTEFIJA C
         WHERE C.ADMPV_NUM_DOC = K_NUMDOC
         AND C.ADMPV_TIPO_DOC = K_TIPODOC
         AND C.ADMPC_ESTADO='A';

         SELECT COUNT(*) INTO V_FLAGMOVIL
         FROM PCLUB.ADMPT_CLIENTE C
         WHERE C.ADMPV_NUM_DOC = K_NUMDOC
         AND C.ADMPV_TIPO_DOC = K_TIPODOC
         AND C.ADMPC_ESTADO='A';

    IF V_FLAGFIJA = 0 AND V_FLAGMOVIL = 0 THEN

        UPDATE PCLUB.ADMPT_CLIENTECUPONERA
        SET ADMPC_ESTADO = 'B',
              ADMPD_FEC_MOD = SYSDATE,
              ADMPV_USU_MOD = K_USUARIO
        WHERE ADMPV_NUM_DOC = UPPER(K_NUMDOC)
        AND ADMPV_TIPO_DOC = K_TIPODOC
        AND ADMPC_ESTADO='A';
    ELSE
        K_CODERROR  := 1;
        K_DESCERROR := 'No se elimino ya que hay servicios con estado de ALTA.';
        RAISE EX_ERROR;
    END IF;

BEGIN
        SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
        FROM PCLUB.ADMPT_ERRORES_CC
        WHERE ADMPN_COD_ERROR=K_CODERROR;
 EXCEPTION WHEN OTHERS THEN
                K_DESCERROR:='ERROR';
END;

INSERT INTO PCLUB.ADMPT_CLIENTECUPONERALOG(ADMPV_TIPO_DOC,ADMPV_NUM_DOC,ADMPC_ESTADO,ADMPD_FEC_REG,ADMPV_USU_REG,ADMPV_PROCESO,ADMPV_ORIGEN)
VALUES(K_TIPODOC,UPPER(K_NUMDOC),'R',SYSDATE,K_USUARIO,'B',K_ORIGEN);

EXCEPTION
    WHEN EX_ERROR THEN

        INSERT INTO PCLUB.ADMPT_CLIENTECUPONERALOG(ADMPV_TIPO_DOC,ADMPV_NUM_DOC,ADMPC_ESTADO,ADMPD_FEC_REG,ADMPV_USU_REG,ADMPV_PROCESO,ADMPV_ORIGEN)
        VALUES(K_TIPODOC,UPPER(K_NUMDOC),'N',SYSDATE,K_USUARIO,'B',K_ORIGEN);

        BEGIN
                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                FROM PCLUB.ADMPT_ERRORES_CC
                WHERE ADMPN_COD_ERROR=K_CODERROR;
        EXCEPTION WHEN OTHERS THEN
            K_DESCERROR:='';
        END;

    WHEN OTHERS THEN
            K_CODERROR  := 1;
            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);

            INSERT INTO PCLUB.ADMPT_CLIENTECUPONERALOG(ADMPV_TIPO_DOC,ADMPV_NUM_DOC,ADMPC_ESTADO,ADMPD_FEC_REG,ADMPV_USU_REG,ADMPV_PROCESO)
            VALUES(K_TIPODOC,UPPER(K_NUMDOC),'N',SYSDATE,K_USUARIO,'B');

END ADMPSI_BAJACLIENTE;

PROCEDURE ADMPSI_ACTCLIENTE(K_COD_CLI IN NUMBER,K_NOMCLI IN VARCHAR2,K_APECLI IN VARCHAR2,K_EMAIL IN VARCHAR2,K_ESTADO IN VARCHAR2,
                                                    K_COD_SEG IN NUMBER,K_USUARIO IN VARCHAR2, K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS
EX_ERROR EXCEPTION;
V_CONT NUMBER;
C_COD_CLI NUMBER;
V_TIP_DOC VARCHAR2(10);
V_NUM_DOC VARCHAR2(40);
BEGIN
K_CODERROR:=0;
K_DESCERROR:=' ';

    IF K_COD_CLI IS NULL THEN
         K_CODERROR  := 14;
         K_DESCERROR := 'No se podrá realizar la actualización. ';
         RAISE EX_ERROR;
     END IF;

     IF K_COD_SEG IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'El código de segmento es un dato obligatorio el Nro de Dcto. ';
         RAISE EX_ERROR;
     END IF;

     IF K_NOMCLI IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'No ingresó el nombre del cliente. ';
         RAISE EX_ERROR;
     END IF;

     SELECT COUNT(*) INTO V_CONT
     FROM PCLUB.ADMPT_CLIENTECUPONERA C
     WHERE C.ADMPN_COD_CLI = K_COD_CLI;

     IF V_CONT=0 THEN
         K_CODERROR  := 14;
         K_DESCERROR := 'El cliente no está registrado. ';
         RAISE EX_ERROR;
     END IF;

     IF K_ESTADO = 'A' THEN

         SELECT C.ADMPV_NUM_DOC,C.ADMPV_TIPO_DOC INTO V_NUM_DOC,V_TIP_DOC
         FROM PCLUB.ADMPT_CLIENTECUPONERA C
         WHERE C.ADMPN_COD_CLI = K_COD_CLI;

         SELECT COUNT(*) INTO V_CONT
         FROM PCLUB.ADMPT_CLIENTECUPONERA C
         WHERE C.ADMPN_COD_CLI <> K_COD_CLI
         AND C.ADMPV_NUM_DOC=V_NUM_DOC
         AND C.ADMPV_TIPO_DOC=V_TIP_DOC
         AND C.ADMPC_ESTADO=K_ESTADO;

         IF V_CONT>0 THEN
             K_CODERROR  := 14;
             K_DESCERROR := 'La persona ya se encuentra en estado ACTIVO. ';
             RAISE EX_ERROR;
         END IF;

     END IF;

     UPDATE PCLUB.ADMPT_CLIENTECUPONERA
     SET ADMPV_NOM_CLI = K_NOMCLI,
           ADMPV_APE_CLI =  K_APECLI,
           ADMPV_EMAIL = K_EMAIL,
           ADMPN_COD_SEG = K_COD_SEG,
           ADMPC_ESTADO = K_ESTADO,
           ADMPV_USU_MOD = K_USUARIO,
           ADMPD_FEC_MOD = SYSDATE
     WHERE ADMPN_COD_CLI = K_COD_CLI;

     COMMIT;

    BEGIN
            SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
            FROM PCLUB.ADMPT_ERRORES_CC
            WHERE ADMPN_COD_ERROR=K_CODERROR;
     EXCEPTION WHEN OTHERS THEN
                    K_DESCERROR:='ERROR';
    END;

EXCEPTION
    WHEN EX_ERROR THEN
        BEGIN
                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                FROM PCLUB.ADMPT_ERRORES_CC
                WHERE ADMPN_COD_ERROR=K_CODERROR;
        EXCEPTION WHEN OTHERS THEN
            K_DESCERROR:='';
        END;
    WHEN OTHERS THEN
            K_CODERROR  := 1;
            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);
END ADMPSI_ACTCLIENTE;

--PROCEDURE ADMPSI_CONCLIENTE(K_NUMDOC IN VARCHAR2,K_NOMCLI IN VARCHAR2,K_APECLI IN VARCHAR2,K_CUR_CLIE OUT SYS_REFCURSOR,K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS
--EX_ERROR EXCEPTION;
--V_SQL VARCHAR2(2000);
--V_TIP_DOC VARCHAR2(10);
--BEGIN
--K_CODERROR:=0;
--K_DESCERROR:=' ';
--
--V_SQL:='SELECT C.ADMPN_COD_CLI,C.ADMPV_NOM_CLI,C.ADMPV_APE_CLI,C.ADMPV_EMAIL,C.ADMPV_TIPO_DOC,C.ADMPV_NUM_DOC,C.ADMPC_ESTADO,S.ADMPV_DESCRIPCION
--             FROM PCLUB.ADMPT_CLIENTECUPONERA C, PCLUB.ADMPT_SEGMENTOCUPONERA S
--             WHERE C.ADMPN_COD_SEG = S.ADMPN_COD_SEG ';
--
--IF K_NUMDOC IS NOT NULL THEN
--
--    IF LENGTH(K_NUMDOC)=8 THEN
--        V_TIP_DOC:='2';
--    ELSE
--        V_TIP_DOC:='4';
--    END IF;
--    V_SQL:=V_SQL || ' AND C.ADMPV_TIPO_DOC = ''' || V_TIP_DOC || '''
--                 AND C.ADMPV_NUM_DOC = ''' || TRIM(K_NUMDOC) || '''';
--
--END IF;
--
--IF K_NOMCLI IS NOT NULL THEN
--    V_SQL:=V_SQL || ' AND C.ADMPV_NOM_CLI LIKE  ''%' || TRIM(K_NOMCLI) || '%''';
--END IF;
--
--IF K_APECLI IS NOT NULL THEN
--    V_SQL:=V_SQL || ' AND C.ADMPV_APE_CLI LIKE ''%' || TRIM(K_APECLI) || '%''';
--END IF;
--
--OPEN K_CUR_CLIE FOR V_SQL;
--
--
--    BEGIN
--            SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
--            FROM PCLUB.ADMPT_ERRORES_CC
--            WHERE ADMPN_COD_ERROR=K_CODERROR;
--    EXCEPTION WHEN OTHERS THEN
--                    K_DESCERROR:='ERROR';
--    END;
--
--EXCEPTION
--    WHEN EX_ERROR THEN
--        BEGIN
--                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
--                FROM PCLUB.ADMPT_ERRORES_CC
--                WHERE ADMPN_COD_ERROR=K_CODERROR;
--        EXCEPTION WHEN OTHERS THEN
--            K_DESCERROR:='';
--        END;
--    WHEN OTHERS THEN
--            K_CODERROR  := 1;
--            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);
--END ADMPSI_CONCLIENTE;

 PROCEDURE ADMPSI_ALTAMASIVA(K_FECHA IN DATE,K_NOM_ARCH IN VARCHAR2,K_USUARIO IN VARCHAR2,K_NUMREGTOT OUT NUMBER,
                                                K_NUMREGPRO OUT NUMBER, K_NUMREGERR OUT NUMBER, K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS
 EX_ERROR EXCEPTION;

 TYPE REG IS RECORD(
  TIPO_DOC  VARCHAR2(20 BYTE),
  NUM_DOC   VARCHAR2(20 BYTE),
  NOM_CLI    VARCHAR2(80 BYTE),
  APE_CLI     VARCHAR2(200 BYTE),
  EMAIL        VARCHAR2(100 BYTE),
  COD_SEG   NUMBER,
  NOM_ARCH   VARCHAR2(100 BYTE),
  FEC_PROC   DATE,
  SEQ            NUMBER,
  DES_ERROR  VARCHAR2(200 BYTE),
  COD_ERROR  NUMBER,
  SEG           VARCHAR2(2 BYTE)
);
vREGCLI REG;

NUM_DOC_AUX NUMBER;

 CURSOR ALTACLI IS
 SELECT * FROM PCLUB.ADMPT_TMP_ALTAMASIVACUPONERA A
 WHERE A.ADMPD_FEC_PROC=K_FECHA
 AND A.ADMPV_NOM_ARCH=K_NOM_ARCH
 AND A.ADMPV_DES_ERROR IS NULL;

 V_REGCLI NUMBER;
 V_COUNT_CLI NUMBER;
 V_CADENA VARCHAR2(450);
 V_REG_VALIDO CHAR(1);

 BEGIN
 K_CODERROR:=0;
 K_DESCERROR:=' ';
 V_REG_VALIDO:='V';

 UPDATE PCLUB.ADMPT_TMP_ALTAMASIVACUPONERA A
 SET A.ADMPV_DES_ERROR='El tipo o Nro. de documento son obligatorios.',
       A.ADMPN_COD_ERROR=50
 WHERE (A.ADMPV_TIPO_DOC IS NULL OR A.ADMPV_NUM_DOC IS NULL)
 AND A.ADMPD_FEC_PROC=K_FECHA
 AND A.ADMPV_NOM_ARCH=K_NOM_ARCH
 AND A.ADMPV_DES_ERROR IS NULL;

 UPDATE PCLUB.ADMPT_TMP_ALTAMASIVACUPONERA A
 SET A.ADMPV_DES_ERROR='El tipo de documento no es aceptado.',
       A.ADMPN_COD_ERROR=51
 WHERE (A.ADMPV_TIPO_DOC <> '2' AND A.ADMPV_TIPO_DOC <> '4')
 AND A.ADMPD_FEC_PROC=K_FECHA
 AND A.ADMPV_NOM_ARCH=K_NOM_ARCH
 AND A.ADMPV_DES_ERROR IS NULL;

 UPDATE PCLUB.ADMPT_TMP_ALTAMASIVACUPONERA A
 SET A.ADMPV_DES_ERROR='DNI no válido.',
       A.ADMPN_COD_ERROR=52
 WHERE (A.ADMPV_TIPO_DOC = '2' AND LENGTH(A.ADMPV_NUM_DOC) <> 8)
 AND A.ADMPD_FEC_PROC=K_FECHA
 AND A.ADMPV_NOM_ARCH=K_NOM_ARCH
 AND A.ADMPV_DES_ERROR IS NULL;

 UPDATE PCLUB.ADMPT_TMP_ALTAMASIVACUPONERA A
 SET A.ADMPV_DES_ERROR='El Cod. de segmento es un dato obligatorio.',
       A.ADMPN_COD_ERROR=53
 WHERE A.ADMPV_SEG IS NULL
 AND A.ADMPD_FEC_PROC=K_FECHA
 AND A.ADMPV_NOM_ARCH=K_NOM_ARCH
 AND A.ADMPV_DES_ERROR IS NULL;

 UPDATE PCLUB.ADMPT_TMP_ALTAMASIVACUPONERA A
 SET A.ADMPV_DES_ERROR='El cliente ya se encuentra registrado.',
       A.ADMPN_COD_ERROR=54
 WHERE A.ADMPD_FEC_PROC=K_FECHA
 AND A.ADMPV_NOM_ARCH=K_NOM_ARCH
 AND A.ADMPV_DES_ERROR IS NULL
 AND EXISTS (SELECT 1 FROM PCLUB.ADMPT_CLIENTECUPONERA C WHERE C.ADMPV_TIPO_DOC=A.ADMPV_TIPO_DOC AND C.ADMPV_NUM_DOC=A.ADMPV_NUM_DOC
                                                                                      AND C.ADMPC_ESTADO='A' );

 UPDATE PCLUB.ADMPT_TMP_ALTAMASIVACUPONERA A
    SET A.ADMPN_COD_SEG=(SELECT S.ADMPN_COD_SEG FROM PCLUB.ADMPT_SEGMENTOCUPONERA S WHERE S.ADMPV_DESCRIPCION =A.ADMPV_SEG)
 WHERE A.ADMPD_FEC_PROC=K_FECHA
 AND A.ADMPV_NOM_ARCH=K_NOM_ARCH
 AND A.ADMPV_DES_ERROR IS NULL;

UPDATE PCLUB.ADMPT_TMP_ALTAMASIVACUPONERA A
 SET A.ADMPV_DES_ERROR='El segmento no existe',
       A.ADMPN_COD_ERROR=55
 WHERE A.ADMPD_FEC_PROC=K_FECHA
 AND A.ADMPV_NOM_ARCH=K_NOM_ARCH
 AND A.ADMPV_DES_ERROR IS NULL
 AND NOT EXISTS (SELECT 1 FROM PCLUB.ADMPT_SEGMENTOCUPONERA S WHERE S.ADMPN_COD_SEG =A.ADMPN_COD_SEG);

 OPEN ALTACLI;
     FETCH ALTACLI INTO vREGCLI;

     WHILE ALTACLI%FOUND
       LOOP

         SELECT translate(vREGCLI.TIPO_DOC||vREGCLI.NUM_DOC||NVL(vREGCLI.NOM_CLI,'')||NVL(vREGCLI.APE_CLI,'')||vREGCLI.SEG,'#$|~^¬´áéíóúñÁÉÍÓÚÑ','abcdefghijklmnopqrs')
             into V_CADENA FROM dual;
        IF vREGCLI.TIPO_DOC||vREGCLI.NUM_DOC||NVL(vREGCLI.NOM_CLI,'')||NVL(vREGCLI.APE_CLI,'')||vREGCLI.SEG <> V_CADENA THEN
           V_REG_VALIDO:='F';
          UPDATE PCLUB.ADMPT_TMP_ALTAMASIVACUPONERA A
                 SET A.ADMPV_DES_ERROR='El Registro contiene Caracteres No Permitidos',
                     A.ADMPN_COD_ERROR=50
          WHERE A.ADMPD_FEC_PROC=K_FECHA  AND A.ADMPV_NOM_ARCH=K_NOM_ARCH  AND
              A.ADMPV_DES_ERROR IS NULL AND A.ADMPV_TIPO_DOC = vREGCLI.TIPO_DOC AND
              A.ADMPV_NUM_DOC = vREGCLI.NUM_DOC  AND A.ADMPV_NOM_CLI = vREGCLI.NOM_CLI AND
              A.ADMPV_APE_CLI = vREGCLI.APE_CLI AND A.ADMPV_EMAIL= vREGCLI.EMAIL AND A.ADMPV_SEG = vREGCLI.SEG;
        END IF;

        IF V_REG_VALIDO= 'V' THEN
          SELECT COUNT(*) INTO V_REGCLI
          FROM PCLUB.ADMPT_AUX_ALTAMASIVACUPONERA T
          WHERE T.ADMPV_TIPO_DOC = vREGCLI.TIPO_DOC
          AND T.ADMPV_NUM_DOC = vREGCLI.NUM_DOC
          AND T.ADMPD_FEC_PROC = vREGCLI.FEC_PROC
          AND T.ADMPV_NOM_ARCH = vREGCLI.NOM_ARCH;

           IF V_REGCLI = 0 THEN
                NUM_DOC_AUX:=1;
                BEGIN
                    IF vREGCLI.TIPO_DOC='2' THEN
                        NUM_DOC_AUX:=TO_NUMBER(vREGCLI.NUM_DOC);
                    END IF;

                EXCEPTION WHEN OTHERS THEN
                     NUM_DOC_AUX:=0;
                END;

                IF NUM_DOC_AUX<>0 THEN

                    INSERT INTO PCLUB.ADMPT_CLIENTECUPONERA(ADMPN_COD_CLI,ADMPV_TIPO_DOC,ADMPV_NUM_DOC,ADMPV_NOM_CLI,ADMPV_APE_CLI,ADMPV_EMAIL,ADMPC_ESTADO,ADMPN_COD_SEG,ADMPD_FEC_REG,ADMPV_USU_REG,ADMPV_ESTADO_CON)
                    VALUES (PCLUB.ADMPT_CLIECUPONERA_SQ.NEXTVAL,vREGCLI.TIPO_DOC,vREGCLI.NUM_DOC,vREGCLI.NOM_CLI,vREGCLI.APE_CLI,vREGCLI.EMAIL,'A',vREGCLI.COD_SEG,SYSDATE,K_USUARIO,'A');

                    INSERT INTO PCLUB.ADMPT_CLIENTECUPONERALOG(ADMPV_TIPO_DOC,ADMPV_NUM_DOC,ADMPV_NOM_CLI,ADMPV_APE_CLI,ADMPV_EMAIL,ADMPC_ESTADO,ADMPD_FEC_REG,ADMPV_USU_REG,ADMPV_COD_SEG,ADMPV_ORIGEN,ADMPV_PROCESO)
                    VALUES(vREGCLI.TIPO_DOC,vREGCLI.NUM_DOC,vREGCLI.NOM_CLI,vREGCLI.APE_CLI,vREGCLI.EMAIL,'R',SYSDATE,K_USUARIO,vREGCLI.COD_SEG,'MASIVO','A');

                    INSERT INTO PCLUB.ADMPT_AUX_ALTAMASIVACUPONERA VALUES(vREGCLI.TIPO_DOC,vREGCLI.NUM_DOC,vREGCLI.NOM_CLI,vREGCLI.APE_CLI,vREGCLI.EMAIL,vREGCLI.COD_SEG,vREGCLI.NOM_ARCH,vREGCLI.FEC_PROC,vREGCLI.SEQ);

                ELSE
                    UPDATE PCLUB.ADMPT_TMP_ALTAMASIVACUPONERA T
                    SET T.ADMPV_DES_ERROR='DNI tiene formato no valido.',
                           T.ADMPN_COD_ERROR=101
                    WHERE T.ADMPV_TIPO_DOC = vREGCLI.TIPO_DOC
                    AND T.ADMPV_NUM_DOC = vREGCLI.NUM_DOC
                    AND T.ADMPD_FEC_PROC = vREGCLI.FEC_PROC
                    AND T.ADMPV_NOM_ARCH = vREGCLI.NOM_ARCH
                    AND T.ADMPN_SEQ = vREGCLI.SEQ;

                END IF;
           ELSE
                UPDATE PCLUB.ADMPT_TMP_ALTAMASIVACUPONERA T
                SET T.ADMPV_DES_ERROR='El cliente ya fue procesado.',
                       T.ADMPN_COD_ERROR=101
                WHERE T.ADMPV_TIPO_DOC = vREGCLI.TIPO_DOC
                AND T.ADMPV_NUM_DOC = vREGCLI.NUM_DOC
                AND T.ADMPD_FEC_PROC = vREGCLI.FEC_PROC
                AND T.ADMPV_NOM_ARCH = vREGCLI.NOM_ARCH
                AND T.ADMPN_SEQ = vREGCLI.SEQ;

           END IF;
        END IF;
       V_REG_VALIDO:='V';
       FETCH ALTACLI INTO vREGCLI;
       END LOOP;

 INSERT INTO PCLUB.ADMPT_IMP_ALTAMASIVACUPONERA
    SELECT  PCLUB.ADMPT_ALTAMASCUPONERA_SQ.NEXTVAL , ADMPV_TIPO_DOC , ADMPV_NUM_DOC, ADMPV_NOM_CLI,ADMPV_APE_CLI,ADMPV_EMAIL,
    ADMPV_SEG, ADMPV_NOM_ARCH,ADMPD_FEC_PROC,ADMPN_SEQ,ADMPV_DES_ERROR,ADMPN_COD_ERROR
    FROM PCLUB.ADMPT_TMP_ALTAMASIVACUPONERA
    WHERE ADMPD_FEC_PROC=K_FECHA
    AND ADMPV_NOM_ARCH=K_NOM_ARCH;

  -- Generar Resultados (Total registros, Total procesados, Total de errores)
    SELECT COUNT (1) INTO K_NUMREGTOT FROM PCLUB.ADMPT_TMP_ALTAMASIVACUPONERA WHERE ADMPD_FEC_PROC=K_FECHA AND ADMPV_NOM_ARCH=K_NOM_ARCH;
    SELECT COUNT (1) INTO K_NUMREGERR FROM PCLUB.ADMPT_TMP_ALTAMASIVACUPONERA WHERE ADMPD_FEC_PROC=K_FECHA AND (ADMPV_DES_ERROR IS NOT NULL) AND ADMPV_NOM_ARCH=K_NOM_ARCH;
    SELECT COUNT (1) INTO K_NUMREGPRO FROM PCLUB.ADMPT_AUX_ALTAMASIVACUPONERA WHERE ADMPD_FEC_PROC=K_FECHA AND ADMPV_NOM_ARCH=K_NOM_ARCH;

   -- Eliminamos los registros de la tabla temporal y auxiliar
   DELETE PCLUB.ADMPT_AUX_ALTAMASIVACUPONERA WHERE ADMPD_FEC_PROC=K_FECHA;
   DELETE PCLUB.ADMPT_TMP_ALTAMASIVACUPONERA WHERE ADMPD_FEC_PROC=K_FECHA;



 COMMIT;

     BEGIN
            SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
            FROM PCLUB.ADMPT_ERRORES_CC
            WHERE ADMPN_COD_ERROR=K_CODERROR;
    EXCEPTION WHEN OTHERS THEN
                    K_DESCERROR:='ERROR';
    END;

EXCEPTION
    WHEN EX_ERROR THEN
        BEGIN
                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                FROM PCLUB.ADMPT_ERRORES_CC
                WHERE ADMPN_COD_ERROR=K_CODERROR;
        EXCEPTION WHEN OTHERS THEN
            K_DESCERROR:='';
        END;
    WHEN OTHERS THEN
            K_CODERROR  := 1;
            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);
 END ADMPSI_ALTAMASIVA;

 PROCEDURE ADMPSI_EALTAMASIVA(K_FECHA IN DATE,K_NOM_ARCH IN VARCHAR2,K_CUR_CLIE OUT SYS_REFCURSOR,K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS
 EX_ERROR EXCEPTION;

 BEGIN
 K_CODERROR:=0;
 K_DESCERROR:=' ';

 OPEN K_CUR_CLIE FOR
 SELECT ADMPV_TIPO_DOC,ADMPV_NUM_DOC,ADMPV_SEG,ADMPV_NOM_ARCH, ADMPV_DES_ERROR
FROM PCLUB.ADMPT_IMP_ALTAMASIVACUPONERA
WHERE ADMPD_FEC_PROC=K_FECHA AND (ADMPV_DES_ERROR IS NOT NULL)
AND ADMPV_NOM_ARCH=K_NOM_ARCH;

     BEGIN
            SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
            FROM PCLUB.ADMPT_ERRORES_CC
            WHERE ADMPN_COD_ERROR=K_CODERROR;
    EXCEPTION WHEN OTHERS THEN
                    K_DESCERROR:='ERROR';
    END;

EXCEPTION
    WHEN EX_ERROR THEN
        BEGIN
                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                FROM PCLUB.ADMPT_ERRORES_CC
                WHERE ADMPN_COD_ERROR=K_CODERROR;
        EXCEPTION WHEN OTHERS THEN
            K_DESCERROR:='';
        END;
    WHEN OTHERS THEN
            K_CODERROR  := 1;
            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);
 END ADMPSI_EALTAMASIVA;

PROCEDURE ADMPSI_MIGRACIONCLIE(K_USUARIO IN VARCHAR2,K_NUMREGTOT OUT NUMBER,K_NUMREGPRO OUT NUMBER, K_NUMREGERR OUT NUMBER, K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS
EX_ERROR EXCEPTION;

TYPE REG IS RECORD(
TIPO_DOC VARCHAR2(20),
NUM_DOC VARCHAR2(40),
NOM_CLI VARCHAR2(50),
APE_CLI VARCHAR2(100),
EMAIL VARCHAR2(100)
);

vREGCLI REG;
V_REGCLI NUMBER;
V_COD_SEG VARCHAR2(2);
V_SEG NUMBER;

CURSOR MIGRACLIE IS
/*SELECT C.ADMPV_TIPO_DOC,C.ADMPV_NUM_DOC,C.ADMPV_NOM_CLI,C.ADMPV_APE_CLI,C.ADMPV_EMAIL
FROM PCLUB.ADMPT_CLIENTE C
WHERE C.ADMPV_TIPO_DOC IN ('2','4')
AND C.ADMPC_ESTADO='A'
UNION ALL
SELECT F.ADMPV_TIPO_DOC,F.ADMPV_NUM_DOC,F.ADMPV_NOM_CLI,F.ADMPV_APE_CLI,F.ADMPV_EMAIL
FROM PCLUB.ADMPT_CLIENTEFIJA F
WHERE F.ADMPV_TIPO_DOC IN ('2','4')
AND F.ADMPC_ESTADO='A';*/
SELECT C.ADMPV_TIPO_DOC,C.ADMPV_NUM_DOC,C.ADMPV_NOM_CLI,C.ADMPV_APE_CLI,C.ADMPV_EMAIL
FROM PCLUB.ADMPT_CLIENTE C
WHERE (C.ADMPV_TIPO_DOC='2' or C.ADMPV_TIPO_DOC='4')
AND C.ADMPC_ESTADO='A'
UNION ALL
SELECT F.ADMPV_TIPO_DOC,F.ADMPV_NUM_DOC,F.ADMPV_NOM_CLI,F.ADMPV_APE_CLI,F.ADMPV_EMAIL
FROM PCLUB.ADMPT_CLIENTEFIJA F
WHERE (F.ADMPV_TIPO_DOC='2' or F.ADMPV_TIPO_DOC='4')
AND F.ADMPC_ESTADO='A';

BEGIN
 K_NUMREGERR:=0;
 K_NUMREGPRO:=0;
 K_CODERROR:=0;
 K_DESCERROR:=' ';

     BEGIN
        SELECT ADMPV_VALOR INTO V_COD_SEG
        FROM PCLUB.ADMPT_PARAMSIST
        WHERE ADMPV_DESC='SEGMENTO_CUPONERA_INICIAL';
    EXCEPTION
        WHEN OTHERS THEN
             K_CODERROR  := 9;
             K_DESCERROR := ' "SEGMENTO_CUPONERA_INICIAL" . ';
             RAISE EX_ERROR;
    END;

    BEGIN
        SELECT ADMPN_COD_SEG INTO V_SEG
        FROM PCLUB.ADMPT_SEGMENTOCUPONERA
        WHERE ADMPV_DESCRIPCION=V_COD_SEG;
    EXCEPTION
        WHEN OTHERS THEN
             K_CODERROR  := 4;
             K_DESCERROR := ' No  existe el segmento asignado . ';
             RAISE EX_ERROR;
    END;


  OPEN MIGRACLIE;
     FETCH MIGRACLIE INTO vREGCLI;

     WHILE MIGRACLIE%FOUND
       LOOP

              SELECT COUNT(*) INTO V_REGCLI
              FROM PCLUB.ADMPT_CLIENTECUPONERA T
              WHERE T.ADMPV_TIPO_DOC = vREGCLI.TIPO_DOC
              AND T.ADMPV_NUM_DOC = vREGCLI.NUM_DOC;

              IF V_REGCLI > 0 THEN

                K_NUMREGERR:=K_NUMREGERR+1;

              ELSE

                K_NUMREGPRO:=K_NUMREGPRO+1;

                 INSERT INTO PCLUB.ADMPT_CLIENTECUPONERA(ADMPN_COD_CLI,ADMPV_TIPO_DOC,ADMPV_NUM_DOC,ADMPV_NOM_CLI,ADMPV_APE_CLI,ADMPV_EMAIL,ADMPC_ESTADO,ADMPN_COD_SEG,ADMPD_FEC_REG,ADMPV_USU_REG,ADMPV_ESTADO_CON)
                VALUES (PCLUB.ADMPT_CLIECUPONERA_SQ.NEXTVAL,vREGCLI.TIPO_DOC,vREGCLI.NUM_DOC,vREGCLI.NOM_CLI,vREGCLI.APE_CLI,vREGCLI.EMAIL,'A',V_SEG,SYSDATE,K_USUARIO,'A');

                --INSERT INTO PCLUB.ADMPT_CLIENTECUPONERALOG(ADMPV_TIPO_DOC,ADMPV_NUM_DOC,ADMPV_NOM_CLI,ADMPV_APE_CLI,ADMPV_EMAIL,ADMPC_ESTADO,ADMPD_FEC_REG,ADMPV_USU_REG,ADMPV_COD_SEG,ADMPV_ORIGEN,ADMPV_PROCESO)
                --VALUES(vREGCLI.TIPO_DOC,vREGCLI.NUM_DOC,vREGCLI.NOM_CLI,vREGCLI.APE_CLI,vREGCLI.EMAIL,'R',SYSDATE,K_USUARIO,V_COD_SEG,'MIGRACION','A');


              END IF;


       FETCH MIGRACLIE INTO vREGCLI;
       END LOOP;

K_NUMREGTOT:=K_NUMREGERR+K_NUMREGPRO;

COMMIT;

     BEGIN
            SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
            FROM PCLUB.ADMPT_ERRORES_CC
            WHERE ADMPN_COD_ERROR=K_CODERROR;
    EXCEPTION WHEN OTHERS THEN
                    K_DESCERROR:='ERROR';
    END;

EXCEPTION
    WHEN EX_ERROR THEN
        BEGIN
                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                FROM PCLUB.ADMPT_ERRORES_CC
                WHERE ADMPN_COD_ERROR=K_CODERROR;
        EXCEPTION WHEN OTHERS THEN
            K_DESCERROR:='';
        END;
    WHEN OTHERS THEN
            K_CODERROR  := 1;
            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);
END ADMPSI_MIGRACIONCLIE;

 PROCEDURE ADMPSI_CONSULTAESTABLECIMIENTO(K_CUR_EST OUT SYS_REFCURSOR,K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS
 EX_ERROR EXCEPTION;

 BEGIN
  K_CODERROR:=0;
 K_DESCERROR:=' ';

     OPEN K_CUR_EST FOR
     SELECT ADMPV_COD_ESTABL ESTABL
     FROM PCLUB.ADMPT_ESTABLECIMIENTO
     WHERE ADMPV_ESTADO='A';

     BEGIN
            SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
            FROM PCLUB.ADMPT_ERRORES_CC
            WHERE ADMPN_COD_ERROR=K_CODERROR;
    EXCEPTION WHEN OTHERS THEN
                    K_DESCERROR:='ERROR';
    END;

EXCEPTION
    WHEN EX_ERROR THEN
        BEGIN
                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                FROM PCLUB.ADMPT_ERRORES_CC
                WHERE ADMPN_COD_ERROR=K_CODERROR;
        EXCEPTION WHEN OTHERS THEN
            K_DESCERROR:='';
        END;
    WHEN OTHERS THEN
            K_CODERROR  := 1;
            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);
 END ADMPSI_CONSULTAESTABLECIMIENTO;

 PROCEDURE ADMPSI_CONSULTASEGMENTO(K_CUR_SEG OUT SYS_REFCURSOR,K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS
  EX_ERROR EXCEPTION;

 BEGIN
  K_CODERROR:=0;
 K_DESCERROR:=' ';

    OPEN K_CUR_SEG FOR
    SELECT ADMPV_DESCRIPCION  DESCR
    FROM PCLUB.ADMPT_SEGMENTOCUPONERA;

    BEGIN
            SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
            FROM PCLUB.ADMPT_ERRORES_CC
            WHERE ADMPN_COD_ERROR=K_CODERROR;
    EXCEPTION WHEN OTHERS THEN
                    K_DESCERROR:='ERROR';
    END;

EXCEPTION
    WHEN EX_ERROR THEN
        BEGIN
                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                FROM PCLUB.ADMPT_ERRORES_CC
                WHERE ADMPN_COD_ERROR=K_CODERROR;
        EXCEPTION WHEN OTHERS THEN
            K_DESCERROR:='';
        END;
    WHEN OTHERS THEN
            K_CODERROR  := 1;
            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);

 END ADMPSI_CONSULTASEGMENTO;


PROCEDURE ADMPSI_CAMBIOTITULAR(K_TIPODOC IN VARCHAR2,K_NUMDOC IN VARCHAR2,K_TIPODOC_N IN VARCHAR2,K_NUMDOC_N IN VARCHAR2,K_NOMCLI IN VARCHAR2,K_APECLI IN VARCHAR2,K_EMAIL IN VARCHAR2,
                                                     K_ORIGEN  IN VARCHAR2, K_USUARIO IN VARCHAR2,K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS
EX_ERROR EXCEPTION;
C_CODERROR NUMBER;
C_DESCERROR VARCHAR2(200);
C_COD_CLI NUMBER;
BEGIN
K_CODERROR:=0;
K_DESCERROR:=' ';

     IF K_TIPODOC IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'No ingreso el tipo de Dcto. a dar de baja. ';
         RAISE EX_ERROR;
     END IF;

     IF K_NUMDOC IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'No ingreso el Nro de Dcto. a dar de baja ';
         RAISE EX_ERROR;
     END IF;

     IF K_TIPODOC_N IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'No ingreso el tipo de Dcto. a registrar. ';
         RAISE EX_ERROR;
     END IF;

     IF K_NUMDOC_N IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'No ingreso el Nro de Dcto. a registrar. ';
         RAISE EX_ERROR;
     END IF;

    ADMPSI_BAJACLIENTE(K_TIPODOC,K_NUMDOC,K_ORIGEN,K_USUARIO,C_COD_CLI,C_CODERROR,C_DESCERROR);

    ADMPSI_ALTACLIENTEDIARIO(K_TIPODOC_N,K_NUMDOC_N,K_NOMCLI,K_APECLI,K_EMAIL,K_ORIGEN,K_USUARIO,C_CODERROR,C_DESCERROR);

    K_CODERROR:=C_CODERROR;
    K_DESCERROR:=C_DESCERROR;

EXCEPTION
    WHEN EX_ERROR THEN
        BEGIN
                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                FROM PCLUB.ADMPT_ERRORES_CC
                WHERE ADMPN_COD_ERROR=K_CODERROR;
        EXCEPTION WHEN OTHERS THEN
            K_DESCERROR:='';
        END;
    WHEN OTHERS THEN
            K_CODERROR  := 1;
            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);
END ADMPSI_CAMBIOTITULAR;

PROCEDURE ADMPSI_CREAESTABLECIMIENTO(K_COD_EST IN VARCHAR2,K_NOM_EST IN VARCHAR2,K_USUARIO IN VARCHAR2,K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS
V_CONT NUMBER;
EX_ERROR EXCEPTION;
BEGIN

K_CODERROR:=0;
K_DESCERROR:=' ';

     IF K_COD_EST IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'Ingrese un código de establecimiento válido. ';
         RAISE EX_ERROR;
     END IF;

     IF K_NOM_EST IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'Ingrese el nombre de establecimiento. ';
         RAISE EX_ERROR;
     END IF;


    SELECT COUNT(E.ADMPV_COD_ESTABL) INTO V_CONT
    FROM PCLUB.ADMPT_ESTABLECIMIENTO E
    WHERE E.ADMPV_COD_ESTABL=K_COD_EST
    AND E.ADMPV_ESTADO='A';

  IF V_CONT > 0 THEN
    K_CODERROR:=15;
    K_DESCERROR:='El código de establecimiento ya se encuentra registrado.';
    RAISE EX_ERROR;
  END IF;

  INSERT INTO PCLUB.ADMPT_ESTABLECIMIENTO(ADMPV_COD_ESTABL,ADMPV_NOM_ESTABL,ADMPD_FEC_REG,ADMPV_USU_REG,ADMPV_ESTADO)
  VALUES(K_COD_EST,K_NOM_EST,SYSDATE,K_USUARIO,'A');

COMMIT;
 BEGIN
        SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
        FROM PCLUB.ADMPT_ERRORES_CC
        WHERE ADMPN_COD_ERROR=K_CODERROR;
EXCEPTION WHEN OTHERS THEN
    K_DESCERROR:='';
END;

EXCEPTION
    WHEN EX_ERROR THEN
        BEGIN
                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                FROM PCLUB.ADMPT_ERRORES_CC
                WHERE ADMPN_COD_ERROR=K_CODERROR;
        EXCEPTION WHEN OTHERS THEN
            K_DESCERROR:='';
        END;
    WHEN OTHERS THEN
            ROLLBACK;
            K_CODERROR  := 1;
            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);

END ADMPSI_CREAESTABLECIMIENTO;

 PROCEDURE ADMPSI_ACTESTABLECIMIENTO(K_COD_EST IN VARCHAR2,K_NOM_EST IN VARCHAR2,K_USUARIO IN VARCHAR2,K_ESTADO IN VARCHAR2,
                                                                K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS

V_CONT NUMBER;
EX_ERROR EXCEPTION;
BEGIN
K_CODERROR:=0;
K_DESCERROR:=' ';

     IF K_COD_EST IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'Ingrese el código de establecimiento válido. ';
         RAISE EX_ERROR;
     END IF;

     IF K_NOM_EST IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'Ingrese el nombre de establecimiento. ';
         RAISE EX_ERROR;
     END IF;

      IF K_ESTADO IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'Ocurrió un error con el estado del cliente. ';
         RAISE EX_ERROR;
     END IF;

    SELECT COUNT(E.ADMPV_COD_ESTABL) INTO V_CONT
    FROM PCLUB.ADMPT_ESTABLECIMIENTO E
    WHERE E.ADMPV_COD_ESTABL=K_COD_EST;

      IF V_CONT = 1 THEN
        UPDATE PCLUB.ADMPT_ESTABLECIMIENTO
        SET ADMPV_NOM_ESTABL = K_NOM_EST,
              ADMPV_ESTADO = K_ESTADO,
              ADMPD_FEC_MOD = SYSDATE,
              ADMPV_USU_MOD = K_USUARIO
        WHERE ADMPV_COD_ESTABL=K_COD_EST;

        /*UPDATE PCLUB.ADMPT_TELEFONOCUPONERA
        SET ADMPV_NUM_TELEFONO = K_NUM_TEL,
              ADMPD_FEC_MOD = SYSDATE,
              ADMPV_USU_MOD = K_USUARIO
        WHERE ADMPV_COD_ESTABL=K_COD_EST;*/

      ELSE
        K_CODERROR  := 17;
        K_DESCERROR := 'El código de establecimiento no existe. ';
        RAISE EX_ERROR;
      END IF;

COMMIT;

BEGIN
        SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
        FROM PCLUB.ADMPT_ERRORES_CC
        WHERE ADMPN_COD_ERROR=K_CODERROR;
EXCEPTION WHEN OTHERS THEN
    K_DESCERROR:='';
END;

EXCEPTION
    WHEN EX_ERROR THEN
        BEGIN
                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                FROM PCLUB.ADMPT_ERRORES_CC
                WHERE ADMPN_COD_ERROR=K_CODERROR;
        EXCEPTION WHEN OTHERS THEN
            K_DESCERROR:='';
        END;
    WHEN OTHERS THEN
            K_CODERROR  := 1;
            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);
END ADMPSI_ACTESTABLECIMIENTO;

PROCEDURE ADMPSI_CONESTABLECIMIENTO(K_COD_EST IN VARCHAR2,K_NOM_EST IN VARCHAR2,K_CUR_EST OUT SYS_REFCURSOR,K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS
EX_ERROR EXCEPTION;
V_SQL VARCHAR2(2000);
BEGIN
K_CODERROR:=0;
K_DESCERROR:=' ';


OPEN K_CUR_EST FOR
  SELECT ADMPV_COD_ESTABL CODIGO,
         ADMPV_NOM_ESTABL NOMBRE,
         TO_CHAR(ADMPD_FEC_REG,'DD/MM/YYYY') FECHA,
         ADMPV_ESTADO ESTADOC,
         CASE WHEN ADMPV_ESTADO ='A' THEN 'ACTIVO' ELSE 'BAJA' END ESTADO
  FROM PCLUB.ADMPT_ESTABLECIMIENTO
  WHERE (ADMPV_COD_ESTABL = K_COD_EST OR K_COD_EST IS NULL)
  AND (ADMPV_NOM_ESTABL LIKE '%'||K_NOM_EST||'%' OR K_NOM_EST IS NULL);

BEGIN
        SELECT ADMPV_DES_ERROR || K_DESCERROR
          INTO K_DESCERROR
        FROM PCLUB.ADMPT_ERRORES_CC
        WHERE ADMPN_COD_ERROR=K_CODERROR;
EXCEPTION WHEN OTHERS THEN
    K_DESCERROR:='';
END;

EXCEPTION
    WHEN EX_ERROR THEN
        BEGIN
                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                FROM PCLUB.ADMPT_ERRORES_CC
                WHERE ADMPN_COD_ERROR=K_CODERROR;
        EXCEPTION WHEN OTHERS THEN
            K_DESCERROR:='';
        END;
    WHEN OTHERS THEN
            K_CODERROR  := 1;
            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);
END ADMPSI_CONESTABLECIMIENTO;

PROCEDURE ADMPSI_ELIMINATELEF_EST(K_COD_EST IN VARCHAR2,K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS
EX_ERROR EXCEPTION;
BEGIN

     IF K_COD_EST IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'Ingrese un código de establecimiento válido. ';
         RAISE EX_ERROR;
     END IF;

    DELETE FROM PCLUB.ADMPT_TELEFONOCUPONERA
         WHERE ADMPV_COD_ESTABL=K_COD_EST;

BEGIN
        SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
        FROM PCLUB.ADMPT_ERRORES_CC
        WHERE ADMPN_COD_ERROR=K_CODERROR;
EXCEPTION WHEN OTHERS THEN
    K_DESCERROR:='';
END;

EXCEPTION
    WHEN EX_ERROR THEN
        BEGIN
                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                FROM PCLUB.ADMPT_ERRORES_CC
                WHERE ADMPN_COD_ERROR=K_CODERROR;
        EXCEPTION WHEN OTHERS THEN
            K_DESCERROR:='';
        END;
    WHEN OTHERS THEN
            K_CODERROR  := 1;
            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);
END ADMPSI_ELIMINATELEF_EST;

PROCEDURE ADMPSI_CREATELEF_EST(K_COD_EST IN VARCHAR2,K_DIR_EST IN VARCHAR2,K_NUM_TEL IN VARCHAR2,K_USUARIO IN VARCHAR2,K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS
V_CONT NUMBER;
EX_ERROR EXCEPTION;
BEGIN
K_CODERROR:=0;
K_DESCERROR:=' ';

     IF K_COD_EST IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'Ingrese un código de establecimiento válido. ';
         RAISE EX_ERROR;
     END IF;

      IF K_NUM_TEL IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'Ingrese el número de teléfono. ';
         RAISE EX_ERROR;
     END IF;


    SELECT COUNT(E.ADMPV_COD_ESTABL) INTO V_CONT
    FROM PCLUB.ADMPT_ESTABLECIMIENTO E
    WHERE E.ADMPV_COD_ESTABL=K_COD_EST;

      IF V_CONT = 1 THEN

        SELECT COUNT(*) INTO V_CONT
        FROM PCLUB.ADMPT_TELEFONOCUPONERA T
        WHERE T.ADMPV_NUM_TELEFONO=K_NUM_TEL;

            IF V_CONT = 0 THEN

                INSERT INTO PCLUB.ADMPT_TELEFONOCUPONERA(ADMPN_COD_TELEFONO,ADMPV_NUM_TELEFONO,ADMPV_COD_ESTABL,ADMPD_FEC_REG,ADMPV_USU_REG,ADMPV_DIR_ESTABL)
                VALUES (PCLUB.ADMPT_TELEF_CUP_SQ.NEXTVAL,K_NUM_TEL,K_COD_EST,SYSDATE,K_USUARIO,K_DIR_EST);

            ELSE

                K_CODERROR  := 17;
                K_DESCERROR := 'El número de teléfono ya se encuentra asociado a un establecimiento ';
                RAISE EX_ERROR;

            END IF;
      ELSE
        K_CODERROR  := 17;
        K_DESCERROR := 'El código de establecimiento no existe. ';
        RAISE EX_ERROR;
      END IF;

COMMIT;

BEGIN
        SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
        FROM PCLUB.ADMPT_ERRORES_CC
        WHERE ADMPN_COD_ERROR=K_CODERROR;
EXCEPTION WHEN OTHERS THEN
    K_DESCERROR:='';
END;

EXCEPTION
    WHEN EX_ERROR THEN
        BEGIN
                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                FROM PCLUB.ADMPT_ERRORES_CC
                WHERE ADMPN_COD_ERROR=K_CODERROR;
        EXCEPTION WHEN OTHERS THEN
            K_DESCERROR:='';
        END;
    WHEN OTHERS THEN
            K_CODERROR  := 1;
            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);
END ADMPSI_CREATELEF_EST;

PROCEDURE ADMPSI_ACTTELEF_EST(K_COD_TEL IN NUMBER,K_COD_EST IN VARCHAR2,K_DIR_EST IN VARCHAR2,K_NUM_TEL IN VARCHAR2,K_USUARIO IN VARCHAR2,
                                                    K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS
V_CONT NUMBER;
EX_ERROR EXCEPTION;
BEGIN
K_CODERROR:=0;
K_DESCERROR:=' ';

     IF K_COD_TEL IS NULL THEN
         K_CODERROR  := 17;
         K_DESCERROR := 'El código de teléfono no es válido. ';
         RAISE EX_ERROR;
     END IF;

     IF K_COD_EST IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'Ingrese un código de establecimiento válido. ';
         RAISE EX_ERROR;
     END IF;

      IF K_NUM_TEL IS NULL THEN

         DELETE FROM PCLUB.ADMPT_TELEFONOCUPONERA
         WHERE ADMPN_COD_TELEFONO=K_COD_TEL;

         COMMIT;

         K_CODERROR  := 0;
         K_DESCERROR := '. ';
         RAISE EX_ERROR;
     END IF;


    SELECT COUNT(E.ADMPV_COD_ESTABL) INTO V_CONT
    FROM PCLUB.ADMPT_TELEFONOCUPONERA E
    WHERE E.ADMPV_COD_ESTABL=K_COD_EST;

      IF V_CONT > 0 THEN

        SELECT COUNT(E.ADMPV_NUM_TELEFONO) INTO V_CONT
        FROM PCLUB.ADMPT_TELEFONOCUPONERA E
        WHERE E.ADMPN_COD_TELEFONO <> K_COD_TEL
        AND E.ADMPV_NUM_TELEFONO=K_NUM_TEL;

        IF V_CONT > 0 THEN
            K_CODERROR  := 17;
            K_DESCERROR := 'El número de teléfono está registrado con otro establecimiento. ';
            RAISE EX_ERROR;

        ELSE
            UPDATE PCLUB.ADMPT_TELEFONOCUPONERA
            SET ADMPV_NUM_TELEFONO = K_NUM_TEL,
              ADMPV_COD_ESTABL = K_COD_EST,
              ADMPV_DIR_ESTABL = K_DIR_EST,
              ADMPD_FEC_MOD = SYSDATE,
              ADMPV_USU_MOD = K_USUARIO
            WHERE ADMPN_COD_TELEFONO = K_COD_TEL;

        END IF;


      ELSE
        K_CODERROR  := 17;
        K_DESCERROR := 'El código de establecimiento no existe. ';
        RAISE EX_ERROR;
      END IF;

COMMIT;

BEGIN
        SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
        FROM PCLUB.ADMPT_ERRORES_CC
        WHERE ADMPN_COD_ERROR=K_CODERROR;
EXCEPTION WHEN OTHERS THEN
    K_DESCERROR:='';
END;

EXCEPTION
    WHEN EX_ERROR THEN
        BEGIN
                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                FROM PCLUB.ADMPT_ERRORES_CC
                WHERE ADMPN_COD_ERROR=K_CODERROR;
        EXCEPTION WHEN OTHERS THEN
            K_DESCERROR:='';
        END;
    WHEN OTHERS THEN
            K_CODERROR  := 1;
            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);
END ADMPSI_ACTTELEF_EST;

PROCEDURE ADMPSI_CONTELEF_EST(K_COD_EST IN VARCHAR2,K_CUR_TEL OUT SYS_REFCURSOR,K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS

EX_ERROR EXCEPTION;
BEGIN
K_CODERROR:=0;
K_DESCERROR:=' ';

     IF K_COD_EST IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'Ingrese un código de establecimiento válido. ';
         RAISE EX_ERROR;
     END IF;


OPEN K_CUR_TEL FOR
SELECT ADMPN_COD_TELEFONO COD,ADMPV_NUM_TELEFONO NUM,ADMPV_DIR_ESTABL DIR FROM PCLUB.ADMPT_TELEFONOCUPONERA
WHERE ADMPV_COD_ESTABL = K_COD_EST;

BEGIN
        SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
        FROM PCLUB.ADMPT_ERRORES_CC
        WHERE ADMPN_COD_ERROR=K_CODERROR;
EXCEPTION WHEN OTHERS THEN
    K_DESCERROR:='';
END;

EXCEPTION
    WHEN EX_ERROR THEN
        BEGIN
                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                FROM PCLUB.ADMPT_ERRORES_CC
                WHERE ADMPN_COD_ERROR=K_CODERROR;
        EXCEPTION WHEN OTHERS THEN
            K_DESCERROR:='';
        END;
    WHEN OTHERS THEN
            K_CODERROR  := 1;
            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);

END ADMPSI_CONTELEF_EST;

PROCEDURE ADMPSI_CREACUPONERA(K_NOM_CUP IN VARCHAR2,K_FEC_INI IN VARCHAR2,K_FEC_FIN IN VARCHAR2,K_USUARIO IN VARCHAR2,K_ID_CUP OUT NUMBER,K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS
EX_ERROR EXCEPTION;
V_CONT NUMBER;
BEGIN
K_CODERROR:=0;
K_DESCERROR:=' ';

     IF K_NOM_CUP IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'Ingrese un nombre para la cuponera válido. ';
         RAISE EX_ERROR;
     END IF;

     IF K_FEC_INI IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'Ingrese la fecha de inicio para la cuponera. ';
         RAISE EX_ERROR;
     END IF;

     IF K_FEC_FIN IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'Ingrese la fecha de fin para la cuponera. ';
         RAISE EX_ERROR;
     END IF;

     IF TO_DATE(K_FEC_FIN,'DD/MM/YYYY') < TO_DATE(K_FEC_INI,'DD/MM/YYYY') THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'La fecha de fin no puede ser menor a la fecha de inicio para la cuponera. ';
         RAISE EX_ERROR;
     END IF;

    /*----Validación que no exista Cuponera con el mismo Nombre----*/
    SELECT COUNT(C.ADMPN_COD_CUP)   INTO V_CONT
           FROM PCLUB.ADMPT_CUPONERA C
    WHERE C.ADMPV_NOM_CUP = K_NOM_CUP ;

    IF V_CONT > 0 THEN
      K_CODERROR:=4;
      K_DESCERROR:='Existe una Cuponera con el mismo Nombre.';
      RAISE EX_ERROR;
    END IF;

    /*Validacion que no exista una Cuponera Activa en el mismo Rango de Fechas Ingresado*/
    SELECT COUNT(C.ADMPN_COD_CUP) INTO V_CONT
    FROM PCLUB.ADMPT_CUPONERA C
    WHERE C.ADMPC_ESTADO<>'B' AND ((TO_DATE(K_FEC_INI,'DD/MM/YYYY') BETWEEN C.ADMPD_FEC_INI AND C.ADMPD_FEC_FIN)
    OR (TO_DATE(K_FEC_FIN,'DD/MM/YYYY') BETWEEN C.ADMPD_FEC_INI AND C.ADMPD_FEC_FIN)
    OR (C.ADMPD_FEC_INI BETWEEN TO_DATE(K_FEC_INI,'DD/MM/YYYY') AND TO_DATE(K_FEC_FIN,'DD/MM/YYYY'))
    OR (C.ADMPD_FEC_FIN BETWEEN TO_DATE(K_FEC_INI,'DD/MM/YYYY') AND TO_DATE(K_FEC_FIN,'DD/MM/YYYY')));

    IF V_CONT > 0 THEN
        K_CODERROR  := 4;
        K_DESCERROR := 'Existe una cuponera en el rango de fecha seleccionada. ';
        RAISE EX_ERROR;
    END IF;

SELECT NVL(PCLUB.ADMPT_CUPONERA_SQ.NEXTVAL,0)  INTO K_ID_CUP FROM DUAL;

 IF K_ID_CUP = 0 THEN
         K_CODERROR  := 14;
         K_DESCERROR := 'No se generó un ID para la cuponera. ';
         RAISE EX_ERROR;
 END IF;

 INSERT INTO PCLUB.ADMPT_CUPONERA(ADMPN_COD_CUP,ADMPV_NOM_CUP,ADMPD_FEC_INI,ADMPD_FEC_FIN,ADMPV_USU_REG,ADMPC_ESTADO)
 VALUES(K_ID_CUP,K_NOM_CUP,TO_DATE(K_FEC_INI,'DD/MM/YYYY'),TO_DATE(K_FEC_FIN,'DD/MM/YYYY'),K_USUARIO,'P');

COMMIT;
BEGIN
        SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
        FROM PCLUB.ADMPT_ERRORES_CC
        WHERE ADMPN_COD_ERROR=K_CODERROR;
EXCEPTION WHEN OTHERS THEN
    K_DESCERROR:='';
END;

EXCEPTION
    WHEN EX_ERROR THEN
        BEGIN
                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                FROM PCLUB.ADMPT_ERRORES_CC
                WHERE ADMPN_COD_ERROR=K_CODERROR;
        EXCEPTION WHEN OTHERS THEN
            K_DESCERROR:='';
        END;
    WHEN OTHERS THEN
            K_CODERROR  := 1;
            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);
END ADMPSI_CREACUPONERA;

 PROCEDURE ADMPSI_CONSULTACUPONERA(K_NOM_CUP IN VARCHAR2,K_CUR_CUP OUT SYS_REFCURSOR,K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS
 EX_ERROR EXCEPTION;
V_SQL VARCHAR2(3000);
BEGIN
K_CODERROR:=0;
K_DESCERROR:=' ';

V_SQL:='SELECT ADMPN_COD_CUP CODIGO,ADMPV_NOM_CUP NOMBRE,TO_CHAR(ADMPD_FEC_INI,''DD/MM/YYYY'') FEC_INI,TO_CHAR(ADMPD_FEC_FIN,''DD/MM/YYYY'') FEC_FIN,
            ADMPC_ESTADO ESTADO, CASE WHEN ADMPC_ESTADO=''P'' THEN ''PROGRAMADO''
            WHEN  ADMPC_ESTADO=''A'' THEN ''ACTIVO'' ELSE ''BAJA'' END ESTADODES
             FROM PCLUB.ADMPT_CUPONERA
             WHERE 1=1 ';--SYSDATE < ADMPD_FEC_FIN ';


    IF K_NOM_CUP IS NOT NULL THEN
         V_SQL:=V_SQL||' AND ADMPV_NOM_CUP LIKE ''%'||K_NOM_CUP||'%''';
     END IF;

OPEN K_CUR_CUP FOR V_SQL;

BEGIN
        SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
        FROM PCLUB.ADMPT_ERRORES_CC
        WHERE ADMPN_COD_ERROR=K_CODERROR;
EXCEPTION WHEN OTHERS THEN
    K_DESCERROR:='';
END;

EXCEPTION
    WHEN EX_ERROR THEN
        BEGIN
                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                FROM PCLUB.ADMPT_ERRORES_CC
                WHERE ADMPN_COD_ERROR=K_CODERROR;
        EXCEPTION WHEN OTHERS THEN
            K_DESCERROR:='';
        END;
    WHEN OTHERS THEN
            K_CODERROR  := 1;
            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);
 END ADMPSI_CONSULTACUPONERA;

PROCEDURE ADMPSI_ACTCUPONERA(K_ID_CUP IN NUMBER,K_NOM_CUP IN VARCHAR2,K_FEC_INI IN VARCHAR2,K_FEC_FIN IN VARCHAR2,K_ESTADO IN VARCHAR2,K_USUARIO IN VARCHAR2,K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS
V_CONT NUMBER;
EX_ERROR EXCEPTION;
V_CONTCUP NUMBER;

BEGIN
K_CODERROR:=0;
K_DESCERROR:=' ';

     IF K_ID_CUP IS NULL THEN
         K_CODERROR  := 17;
         K_DESCERROR := 'El código de CUPONERA no es válido. ';
         RAISE EX_ERROR;
     END IF;

     IF K_NOM_CUP IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'Ingrese el nombre de cuponera válido. ';
         RAISE EX_ERROR;
     END IF;

     IF K_FEC_INI IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'Ingrese la fecha de inicio. ';
         RAISE EX_ERROR;
     END IF;

     IF K_FEC_FIN IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'Ingrese la fecha fin. ';
         RAISE EX_ERROR;
     END IF;

     IF K_ESTADO IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'Ingrese estado de la cuponera. ';
         RAISE EX_ERROR;
      ELSIF K_ESTADO  IN ('A','P') THEN
         SELECT COUNT(C.ADMPN_COD_CUP)   INTO V_CONTCUP
           FROM PCLUB.ADMPT_CUPONERA C
         WHERE C.ADMPV_NOM_CUP = K_NOM_CUP  AND C.ADMPN_COD_CUP<>K_ID_CUP ;

          IF V_CONTCUP > 0 THEN
            K_CODERROR:=4;
            K_DESCERROR:='Existe una Cuponera con el mismo Nombre.';
            RAISE EX_ERROR;
          END IF;

        SELECT COUNT(C.ADMPN_COD_CUP) INTO V_CONTCUP
        FROM PCLUB.ADMPT_CUPONERA C
        WHERE C.ADMPC_ESTADO<>'B' AND ((TO_DATE(K_FEC_INI,'DD/MM/YYYY') BETWEEN C.ADMPD_FEC_INI AND C.ADMPD_FEC_FIN)
        OR (TO_DATE(K_FEC_FIN,'DD/MM/YYYY') BETWEEN C.ADMPD_FEC_INI AND C.ADMPD_FEC_FIN)
        OR (C.ADMPD_FEC_INI BETWEEN TO_DATE(K_FEC_INI,'DD/MM/YYYY') AND TO_DATE(K_FEC_FIN,'DD/MM/YYYY'))
        OR (C.ADMPD_FEC_FIN BETWEEN TO_DATE(K_FEC_INI,'DD/MM/YYYY') AND TO_DATE(K_FEC_FIN,'DD/MM/YYYY')))
         AND  C.ADMPN_COD_CUP<>K_ID_CUP;
        IF V_CONTCUP > 0 THEN
            K_CODERROR  := 4;
            K_DESCERROR := 'Existe una cuponera en el rango de fecha actualizada. ';
            RAISE EX_ERROR;
        END IF;

     END IF;

    SELECT COUNT(E.ADMPN_COD_CUP) INTO V_CONT
    FROM PCLUB.ADMPT_CUPONERA E
    WHERE E.ADMPN_COD_CUP=K_ID_CUP;

      IF V_CONT = 1 THEN

        UPDATE PCLUB.ADMPT_CUPONERA C
        SET C.ADMPC_ESTADO=K_ESTADO,
              C.ADMPD_FEC_INI=TO_DATE(K_FEC_INI,'DD/MM/YYYY'),
              C.ADMPD_FEC_FIN=TO_DATE(K_FEC_FIN,'DD/MM/YYYY'),
              C.ADMPV_NOM_CUP=K_NOM_CUP,
              C.ADMPD_FEC_MOD = SYSDATE,
              C.ADMPV_USU_MOD = K_USUARIO
        WHERE C.ADMPN_COD_CUP=K_ID_CUP;

      ELSE
        K_CODERROR  := 17;
        K_DESCERROR := 'El código de establecimiento no existe. ';
        RAISE EX_ERROR;
      END IF;

COMMIT;

BEGIN
        SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
        FROM PCLUB.ADMPT_ERRORES_CC
        WHERE ADMPN_COD_ERROR=K_CODERROR;
EXCEPTION WHEN OTHERS THEN
    K_DESCERROR:='';
END;

EXCEPTION
    WHEN EX_ERROR THEN
        BEGIN
                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                FROM PCLUB.ADMPT_ERRORES_CC
                WHERE ADMPN_COD_ERROR=K_CODERROR;
        EXCEPTION WHEN OTHERS THEN
            K_DESCERROR:='';
        END;
    WHEN OTHERS THEN
            K_CODERROR  := 1;
            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);

END ADMPSI_ACTCUPONERA;

PROCEDURE ADMPSI_ELIMINACUPONERATMP(K_ID_CUP IN NUMBER,K_FLAG IN VARCHAR2,K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS

EX_ERROR EXCEPTION;
V_CONT NUMBER;
V_EST VARCHAR2(2);
BEGIN
K_CODERROR:=0;
K_DESCERROR:=' ';

    IF K_ID_CUP IS NULL THEN
         K_CODERROR  := 17;
         K_DESCERROR := 'El código de CUPONERA no es válido. ';
         RAISE EX_ERROR;
    END IF;


SELECT COUNT(C.ADMPC_ESTADO) INTO V_CONT
FROM PCLUB.ADMPT_CUPONERA C
WHERE C.ADMPN_COD_CUP=K_ID_CUP;

IF V_CONT =1 THEN
    SELECT C.ADMPC_ESTADO INTO V_EST
    FROM PCLUB.ADMPT_CUPONERA C
    WHERE C.ADMPN_COD_CUP=K_ID_CUP;

ELSE
     K_CODERROR  := 17;
     K_DESCERROR := 'El código de CUPONERA no es válido. ';
     RAISE EX_ERROR;
END IF;

IF V_EST = 'P' THEN

    DELETE FROM PCLUB.ADMPT_TMP_CUPONERA
    WHERE ADMPN_CUPONERA=K_ID_CUP;

    IF K_FLAG <> 'O' THEN
        DELETE FROM PCLUB.ADMPT_CUPONERA
        WHERE ADMPN_COD_CUP=K_ID_CUP;
    END IF;
ELSE
    K_CODERROR  := 17;
     K_DESCERROR := 'Solo se pueden eliminar las cuponeras programadas. ';
     RAISE EX_ERROR;
END IF;

COMMIT;

BEGIN
        SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
        FROM PCLUB.ADMPT_ERRORES_CC
        WHERE ADMPN_COD_ERROR=K_CODERROR;
EXCEPTION WHEN OTHERS THEN
    K_DESCERROR:='';
END;

EXCEPTION
    WHEN EX_ERROR THEN
        BEGIN
                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                FROM PCLUB.ADMPT_ERRORES_CC
                WHERE ADMPN_COD_ERROR=K_CODERROR;
        EXCEPTION WHEN OTHERS THEN
            K_DESCERROR:='';
        END;
    WHEN OTHERS THEN
            K_CODERROR  := 1;
            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);
END ADMPSI_ELIMINACUPONERATMP;

PROCEDURE ADMPSI_ELIMINACUPONERA(K_ID_CUP IN NUMBER,K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS

EX_ERROR EXCEPTION;
V_CONT NUMBER;
V_EST VARCHAR2(2);
BEGIN
K_CODERROR:=0;
K_DESCERROR:=' ';

    IF K_ID_CUP IS NULL THEN
         K_CODERROR  := 17;
         K_DESCERROR := 'El código de CUPONERA no es válido. ';
         RAISE EX_ERROR;
    END IF;


SELECT COUNT(C.ADMPC_ESTADO) INTO V_CONT
FROM PCLUB.ADMPT_CUPONERA C
WHERE C.ADMPN_COD_CUP=K_ID_CUP;

IF V_CONT =1 THEN
    SELECT C.ADMPC_ESTADO INTO V_EST
    FROM PCLUB.ADMPT_CUPONERA C
    WHERE C.ADMPN_COD_CUP=K_ID_CUP;

ELSE
     K_CODERROR  := 17;
     K_DESCERROR := 'El código de CUPONERA no es válido. ';
     RAISE EX_ERROR;
END IF;

IF V_EST = 'P' THEN

    DELETE FROM PCLUB.ADMPT_TMP_CUPONERA
    WHERE ADMPN_CUPONERA=K_ID_CUP;

    DELETE FROM PCLUB.ADMPT_CUPONERA
    WHERE ADMPN_COD_CUP=K_ID_CUP;

ELSE
    K_CODERROR  := 17;
     K_DESCERROR := 'Solo se pueden eliminar las cuponeras programadas. ';
     RAISE EX_ERROR;
END IF;

COMMIT;

BEGIN
        SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
        FROM PCLUB.ADMPT_ERRORES_CC
        WHERE ADMPN_COD_ERROR=K_CODERROR;
EXCEPTION WHEN OTHERS THEN
    K_DESCERROR:='';
END;

EXCEPTION
    WHEN EX_ERROR THEN
        BEGIN
                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                FROM PCLUB.ADMPT_ERRORES_CC
                WHERE ADMPN_COD_ERROR=K_CODERROR;
        EXCEPTION WHEN OTHERS THEN
            K_DESCERROR:='';
        END;
    WHEN OTHERS THEN
            K_CODERROR  := 1;
            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);
END ADMPSI_ELIMINACUPONERA;

/*Reporte de Cuponera luego de llamar ala SQLLoader*/
PROCEDURE ADMPSI_REPORTACUPONERATMP(K_ID_CUP IN NUMBER,K_USUARIO IN VARCHAR2,K_CUR_CUP OUT SYS_REFCURSOR,K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS
/*despues de levantar el loader, se tiene q actualizar la tabla tmp con el cod cuponera generado*/
EX_ERROR EXCEPTION;
V_CONT NUMBER;
BEGIN
K_CODERROR:=0;
K_DESCERROR:=' ';

 IF K_ID_CUP IS NULL THEN
         K_CODERROR  := 17;
         K_DESCERROR := 'El código de CUPONERA no es válido. ';
         RAISE EX_ERROR;
 END IF;

SELECT COUNT(*) INTO V_CONT
FROM PCLUB.ADMPT_TMP_CUPONERA
WHERE ADMPN_CUPONERA=K_ID_CUP;

IF V_CONT = 0 THEN
    UPDATE PCLUB.ADMPT_TMP_CUPONERA
    SET ADMPN_CUPONERA=K_ID_CUP,
    ADMPV_USU_REG=K_USUARIO
    WHERE ADMPN_CUPONERA IS NULL;

    COMMIT;
END IF;

OPEN K_CUR_CUP FOR
SELECT C.ADMPV_DESC_OFERTA DESC_OFERTA,C.ADMPV_CUPON CUPON,C.ADMPV_COD_SEG COD_SEG,C.ADMPV_COD_EST COD_EST,C.ADMPN_NRO_REDEN REDEN,C.ADMPN_FILA FILA,'' OBSERV,'' ACTIVO
FROM PCLUB.ADMPT_TMP_CUPONERA C
WHERE C.ADMPN_CUPONERA=K_ID_CUP
ORDER BY COD_EST,COD_SEG,CUPON;



BEGIN
        SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
        FROM PCLUB.ADMPT_ERRORES_CC
        WHERE ADMPN_COD_ERROR=K_CODERROR;
EXCEPTION WHEN OTHERS THEN
    K_DESCERROR:='';
END;

EXCEPTION
    WHEN EX_ERROR THEN
        BEGIN
                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                FROM PCLUB.ADMPT_ERRORES_CC
                WHERE ADMPN_COD_ERROR=K_CODERROR;
        EXCEPTION WHEN OTHERS THEN
            K_DESCERROR:='';
        END;
        OPEN K_CUR_CUP FOR SELECT '' FROM DUAL WHERE 1=2;
    WHEN OTHERS THEN
            K_CODERROR  := 1;
            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);
            OPEN K_CUR_CUP FOR SELECT '' FROM DUAL WHERE 1=2;
END ADMPSI_REPORTACUPONERATMP;
/*Elimina Oferta Cuponera*/
PROCEDURE ADMPSI_ELIMINAOFERCUPTMP(K_ID_FILA IN NUMBER,K_ID_CUP IN NUMBER,K_CUR_CUP OUT SYS_REFCURSOR,K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS

EX_ERROR EXCEPTION;

BEGIN
K_CODERROR:=0;
K_DESCERROR:=' ';

 IF K_ID_FILA IS NULL THEN
         K_CODERROR  := 17;
         K_DESCERROR := 'La oferta aún no está registrada, no se puede eliminar. ';
         RAISE EX_ERROR;
 END IF;

 IF K_ID_CUP IS NULL THEN
         K_CODERROR  := 17;
         K_DESCERROR := 'El código de CUPONERA no es válido. ';
         RAISE EX_ERROR;
 END IF;

DELETE FROM PCLUB.ADMPT_TMP_CUPONERA
WHERE ADMPN_FILA=K_ID_FILA
AND ADMPN_CUPONERA=K_ID_CUP;

COMMIT;

OPEN K_CUR_CUP FOR
SELECT C.ADMPV_DESC_OFERTA DESC_OFERTA,C.ADMPV_CUPON CUPON,C.ADMPV_COD_SEG COD_SEG,C.ADMPV_COD_EST COD_EST,C.ADMPN_NRO_REDEN REDEN,C.ADMPN_FILA FILA,'' OBSERV,'' ACTIVO
FROM PCLUB.ADMPT_TMP_CUPONERA C
WHERE C.ADMPN_CUPONERA=K_ID_CUP
ORDER BY COD_EST,COD_SEG,CUPON;

BEGIN
        SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
        FROM PCLUB.ADMPT_ERRORES_CC
        WHERE ADMPN_COD_ERROR=K_CODERROR;
EXCEPTION WHEN OTHERS THEN
    K_DESCERROR:='';
END;

EXCEPTION
    WHEN EX_ERROR THEN
        BEGIN
                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                FROM PCLUB.ADMPT_ERRORES_CC
                WHERE ADMPN_COD_ERROR=K_CODERROR;
        EXCEPTION WHEN OTHERS THEN
            K_DESCERROR:='';
        END;
        OPEN K_CUR_CUP FOR SELECT '' FROM DUAL WHERE 1=2;
    WHEN OTHERS THEN
            K_CODERROR  := 1;
            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);
            OPEN K_CUR_CUP FOR SELECT '' FROM DUAL WHERE 1=2;
END ADMPSI_ELIMINAOFERCUPTMP;

/*----Registra una Oferta para una Cuponera Determinada----*/
 PROCEDURE ADMPSI_NUEVOOFERCUPTMP(K_ID_SEG IN VARCHAR2,K_COD_EST IN VARCHAR2,K_COD_CUP IN VARCHAR2,K_DES_OFER IN VARCHAR2,K_NRO_RED IN VARCHAR2,
                K_ID_CUP IN NUMBER,K_USUARIO IN VARCHAR2,K_CUR_CUP OUT SYS_REFCURSOR,K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS

EX_ERROR EXCEPTION;
K_NUM_RED NUMBER;
V_CONT_REG NUMBER;
BEGIN
K_CODERROR:=0;
K_DESCERROR:=' ';

     IF K_ID_SEG IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'El código de segmento no es válido. ';
         RAISE EX_ERROR;
     END IF;

     IF K_COD_EST IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'El código de establecimiento no es válido. ';
         RAISE EX_ERROR;
     END IF;

      IF K_COD_CUP IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'El cupon no es válido. ';
         RAISE EX_ERROR;
     END IF;

      IF K_DES_OFER IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'La descripción de la oferta no es válida. ';
         RAISE EX_ERROR;
     END IF;
     /*
      IF K_NRO_RED IS NULL OR K_NRO_RED<0 THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'El nro. de redenciones no es válido. ';
         RAISE EX_ERROR;
     END IF;*/

       IF K_ID_CUP IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'El código de cuponera no es válido.';
         RAISE EX_ERROR;
     END IF;

    IF K_NRO_RED IS NULL THEN
         K_NUM_RED:=NULL;
    ELSE
         K_NUM_RED:=K_NRO_RED;
    END IF;

    SELECT COUNT(*) INTO V_CONT_REG
      FROM PCLUB.ADMPT_TMP_CUPONERA
    WHERE  ADMPN_CUPONERA=K_ID_CUP AND ADMPV_DESC_OFERTA=K_DES_OFER AND
          ADMPV_CUPON=K_COD_CUP AND ADMPV_COD_SEG=K_ID_SEG AND
          ADMPV_COD_EST = K_COD_EST AND (ADMPN_NRO_REDEN=K_NUM_RED OR ADMPN_NRO_REDEN IS NULL);

  IF V_CONT_REG >0 THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'La Oferta ya fue ingresada.';
         RAISE EX_ERROR;
  END IF;


    INSERT INTO PCLUB.ADMPT_TMP_CUPONERA(ADMPV_DESC_OFERTA,ADMPV_CUPON,ADMPN_CUPONERA,ADMPV_COD_SEG,ADMPV_COD_EST,ADMPN_NRO_REDEN,ADMPD_FEC_PROC,ADMPV_USU_REG)
    VALUES(K_DES_OFER,K_COD_CUP,K_ID_CUP,K_ID_SEG,K_COD_EST,K_NUM_RED,SYSDATE,K_USUARIO);

    COMMIT;

OPEN K_CUR_CUP FOR
SELECT C.ADMPV_DESC_OFERTA DESC_OFERTA,C.ADMPV_CUPON CUPON,C.ADMPV_COD_SEG COD_SEG,C.ADMPV_COD_EST COD_EST,C.ADMPN_NRO_REDEN REDEN,C.ADMPN_FILA FILA,'' OBSERV,'' ACTIVO
FROM PCLUB.ADMPT_TMP_CUPONERA C
WHERE C.ADMPN_CUPONERA=K_ID_CUP
ORDER BY COD_EST,COD_SEG,CUPON;

BEGIN
        SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
        FROM PCLUB.ADMPT_ERRORES_CC
        WHERE ADMPN_COD_ERROR=K_CODERROR;
EXCEPTION WHEN OTHERS THEN
    K_DESCERROR:='';
END;

EXCEPTION
    WHEN EX_ERROR THEN
        BEGIN
                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                FROM PCLUB.ADMPT_ERRORES_CC
                WHERE ADMPN_COD_ERROR=K_CODERROR;
        EXCEPTION WHEN OTHERS THEN
            K_DESCERROR:='';
        END;
         OPEN K_CUR_CUP FOR SELECT '' FROM DUAL WHERE 1=2;
    WHEN OTHERS THEN
            K_CODERROR  := 1;
            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);
            OPEN K_CUR_CUP FOR SELECT '' FROM DUAL WHERE 1=2;
END ADMPSI_NUEVOOFERCUPTMP;


/*----Actualiza una Oferta para una Cuponera Determinada----*/
 PROCEDURE ADMPSI_ACTOFERCUPTMP(K_ID_FILA IN NUMBER,K_ID_SEG IN VARCHAR2,K_COD_EST IN VARCHAR2,K_COD_CUP IN VARCHAR2,K_DES_OFER IN VARCHAR2,K_NRO_RED IN VARCHAR2,
                K_ID_CUP IN NUMBER,K_USUARIO IN VARCHAR2,K_CUR_CUP OUT SYS_REFCURSOR,K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS

EX_ERROR EXCEPTION;
K_NUM_RED NUMBER;
BEGIN
K_CODERROR:=0;
K_DESCERROR:=' ';

     IF K_ID_SEG IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'El código de segmento no es válido. ';
         RAISE EX_ERROR;
     END IF;

     IF K_COD_EST IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'El código de establecimiento no es válido. ';
         RAISE EX_ERROR;
     END IF;

      IF K_COD_CUP IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'El cupón no es válido. ';
         RAISE EX_ERROR;
     END IF;

      IF K_DES_OFER IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'La descripción de la oferta no es válida. ';
         RAISE EX_ERROR;
     END IF;
     /*
      IF K_NRO_RED IS NULL OR K_NRO_RED<0 THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'El nro. de redenciones no es válido. ';
         RAISE EX_ERROR;
     END IF;*/

       IF K_ID_CUP IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'El código de cuponera no es válido.';
         RAISE EX_ERROR;
     END IF;

    IF K_NRO_RED IS NULL THEN
        K_NUM_RED:=NULL;
    ELSE
        K_NUM_RED:=K_NRO_RED;
    END IF;

    UPDATE PCLUB.ADMPT_TMP_CUPONERA
    SET ADMPV_DESC_OFERTA=K_DES_OFER,
          ADMPV_CUPON=K_COD_CUP,
          ADMPV_COD_SEG=K_ID_SEG,
          ADMPV_COD_EST=K_COD_EST,
          ADMPN_NRO_REDEN=K_NUM_RED
     WHERE ADMPN_FILA=K_ID_FILA
     AND ADMPN_CUPONERA=K_ID_CUP;

    COMMIT;

OPEN K_CUR_CUP FOR
SELECT C.ADMPV_DESC_OFERTA DESC_OFERTA,C.ADMPV_CUPON CUPON,C.ADMPV_COD_SEG COD_SEG,C.ADMPV_COD_EST COD_EST,C.ADMPN_NRO_REDEN REDEN,C.ADMPN_FILA FILA,'' OBSERV,'' ACTIVO
FROM PCLUB.ADMPT_TMP_CUPONERA C
WHERE C.ADMPN_CUPONERA=K_ID_CUP
ORDER BY COD_EST,COD_SEG,CUPON;

BEGIN
        SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
        FROM PCLUB.ADMPT_ERRORES_CC
        WHERE ADMPN_COD_ERROR=K_CODERROR;
EXCEPTION WHEN OTHERS THEN
    K_DESCERROR:='';
END;

EXCEPTION
    WHEN EX_ERROR THEN
        BEGIN
                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                FROM PCLUB.ADMPT_ERRORES_CC
                WHERE ADMPN_COD_ERROR=K_CODERROR;
        EXCEPTION WHEN OTHERS THEN
            K_DESCERROR:='';
        END;
       OPEN K_CUR_CUP FOR SELECT '' FROM DUAL WHERE 1=2;
    WHEN OTHERS THEN
            K_CODERROR  := 1;
            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);
            OPEN K_CUR_CUP FOR SELECT '' FROM DUAL WHERE 1=2;
END ADMPSI_ACTOFERCUPTMP;

/*-----Validar las Ofertas de Cargadas a partir de un Archivo de Cuponera --*/
PROCEDURE ADMPSI_VALIDARCUPONERATMP(K_ID_CUP IN NUMBER,K_CUR_CUP OUT SYS_REFCURSOR,K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS

TYPE CUPONOFERTA IS RECORD
(
  DESC_OFERTA  VARCHAR2(200),
  CUPON        NUMBER,
  CUPONERA     NUMBER,
  FEC_PROC     DATE,
  USU_REG      VARCHAR2(20),
  COD_ERROR    NUMBER,
  DESC_ERROR   VARCHAR2(300),
  SEQ          NUMBER,
  COD_SEG      VARCHAR2(2),
  COD_EST      VARCHAR2(10),
  NRO_REDEN    NUMBER,
  FILA         NUMBER,
  SEG         NUMBER
);
OFER CUPONOFERTA;
EX_ERROR EXCEPTION;
V_CADENA VARCHAR2(250);

CURSOR OFERTAS IS
SELECT *
FROM PCLUB.ADMPT_TMP_CUPONERA
WHERE ADMPN_CUPONERA=K_ID_CUP
AND ADMPV_DESC_ERROR IS NULL;

CURSOR OFERTAS_DUPLICADAS IS
SELECT T.ADMPV_DESC_OFERTA,T.ADMPV_CUPON,T.ADMPN_CUPONERA,T.ADMPV_COD_SEG,T.ADMPV_COD_EST,T.ADMPN_NRO_REDEN
FROM PCLUB.ADMPT_TMP_CUPONERA T
 WHERE T.ADMPN_CUPONERA=K_ID_CUP AND ADMPV_DESC_ERROR IS NULL
 GROUP BY T.ADMPV_DESC_OFERTA,T.ADMPV_CUPON,T.ADMPN_CUPONERA,T.ADMPV_COD_SEG,T.ADMPV_COD_EST,T.ADMPN_NRO_REDEN
HAVING COUNT(*)>1;

CURSOR VERIFICAR_CARAC_ESP IS
SELECT A.ADMPV_DESC_OFERTA,A.ADMPV_CUPON,A.ADMPV_COD_SEG,A.ADMPV_COD_EST,A.ADMPN_NRO_REDEN
  FROM PCLUB.ADMPT_TMP_CUPONERA A
WHERE A.ADMPN_CUPONERA=K_ID_CUP AND A.ADMPV_DESC_ERROR IS NULL;


CURSOR CUPONES IS
SELECT T.ADMPV_COD_SEG, T.ADMPV_COD_EST
FROM PCLUB.ADMPT_TMP_CUPONERA T
WHERE T.ADMPN_CUPONERA=K_ID_CUP
--AND T.ADMPV_DESC_ERROR IS NULL
GROUP BY T.ADMPV_COD_SEG, T.ADMPV_COD_EST;

CURSOR OFERTASCUPON(EST VARCHAR2,SEG VARCHAR2) IS
SELECT *
FROM PCLUB.ADMPT_TMP_CUPONERA T
WHERE T.ADMPN_CUPONERA=K_ID_CUP
AND T.ADMPV_COD_EST=EST
AND T.ADMPV_COD_SEG=SEG;

V_COD_SEG VARCHAR2(2);
V_COD_EST VARCHAR2(10);
--V_CUP VARCHAR2(2);
V_DES_OFERTA VARCHAR2(1500);

V_CONT NUMBER;
V_NUM_LEN NUMBER;
V_CARACTER_NUM NUMBER;
V_CONTCUP NUMBER;

BEGIN
K_CODERROR:=0;
K_DESCERROR:=' ';
V_DES_OFERTA:='';

  IF K_ID_CUP IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'El código de cuponera no es válido.';
         RAISE EX_ERROR;
  END IF;

  SELECT COUNT(C.ADMPN_COD_CUP) INTO V_CONTCUP
  FROM PCLUB.ADMPT_CUPONERA C
  WHERE C.ADMPN_COD_CUP=K_ID_CUP;

  IF V_CONTCUP = 0 THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'El código de cuponera no existe.';
         RAISE EX_ERROR;
  END IF;

BEGIN
        SELECT TO_NUMBER(ADMPV_VALOR) INTO V_CARACTER_NUM
        FROM PCLUB.ADMPT_PARAMSIST
        WHERE ADMPV_DESC='TOTAL_CARACTER_SMS';
EXCEPTION WHEN OTHERS THEN
    K_CODERROR:=4;
    K_DESCERROR:='El parámetro "TOTAL_CARACTER_SMS", no se encuentra registrado. ';
    RAISE EX_ERROR;
END;

UPDATE PCLUB.ADMPT_TMP_CUPONERA
SET ADMPV_DESC_ERROR = NULL
WHERE ADMPN_CUPONERA=K_ID_CUP;

UPDATE PCLUB.ADMPT_TMP_CUPONERA
SET ADMPV_DESC_ERROR='Ingrese todos los valores ya que son obligatorios, a excepcion de nro de redenciones.',
      ADMPV_COD_ERROR=101
WHERE ADMPN_CUPONERA=K_ID_CUP
AND ADMPV_DESC_ERROR IS NULL
AND (ADMPV_DESC_OFERTA IS NULL OR ADMPV_CUPON IS NULL OR ADMPN_CUPONERA IS NULL
        OR ADMPV_COD_SEG IS NULL OR ADMPV_COD_EST IS NULL);

OPEN VERIFICAR_CARAC_ESP;
FETCH VERIFICAR_CARAC_ESP INTO OFER.DESC_OFERTA,OFER.CUPON, OFER.COD_SEG,OFER.COD_EST,OFER.NRO_REDEN;
WHILE VERIFICAR_CARAC_ESP%FOUND
LOOP
  SELECT translate(OFER.DESC_OFERTA||OFER.CUPON||OFER.COD_SEG||OFER.COD_EST||NVL(OFER.NRO_REDEN,0),'#$|~^¬´áéíóúñÁÉÍÓÚÑ','abcdefghijklmnopqrs')
         into V_CADENA FROM dual;
   IF OFER.DESC_OFERTA||OFER.CUPON||OFER.COD_SEG||OFER.COD_EST||NVL(OFER.NRO_REDEN,0) <> V_CADENA THEN
      UPDATE PCLUB.ADMPT_TMP_CUPONERA A SET ADMPV_DESC_ERROR='El Registro contiene Caracteres No Permitidos.', ADMPV_COD_ERROR=102
     WHERE  A.ADMPN_CUPONERA=K_ID_CUP AND A.ADMPV_DESC_OFERTA=OFER.DESC_OFERTA AND
            A.ADMPV_CUPON=OFER.CUPON AND A.ADMPV_COD_SEG=OFER.COD_SEG AND
            A.ADMPV_COD_EST = OFER.COD_EST AND (A.ADMPN_NRO_REDEN=OFER.NRO_REDEN  OR A.ADMPN_NRO_REDEN IS NULL);
   END IF;

FETCH VERIFICAR_CARAC_ESP INTO OFER.DESC_OFERTA,OFER.CUPON, OFER.COD_SEG,OFER.COD_EST,OFER.NRO_REDEN;
END LOOP;
CLOSE VERIFICAR_CARAC_ESP;


OPEN OFERTAS;
FETCH OFERTAS INTO OFER;
WHILE OFERTAS%FOUND
LOOP

    SELECT COUNT(*) INTO V_CONT
    FROM PCLUB.ADMPT_SEGMENTOCUPONERA S
    WHERE S.ADMPV_DESCRIPCION=OFER.COD_SEG;

    IF V_CONT = 0 THEN

        UPDATE PCLUB.ADMPT_TMP_CUPONERA
        SET ADMPV_DESC_ERROR='El código de segmento no existe.',
              ADMPV_COD_ERROR=102
        WHERE ADMPN_FILA=OFER.FILA
            AND ADMPN_CUPONERA=K_ID_CUP;
    END IF;

    SELECT COUNT(*) INTO V_CONT
    FROM PCLUB.ADMPT_ESTABLECIMIENTO E
    WHERE E.ADMPV_COD_ESTABL=OFER.COD_EST
    AND E.ADMPV_ESTADO='A';

    IF V_CONT = 0 THEN

        UPDATE PCLUB.ADMPT_TMP_CUPONERA
        SET ADMPV_DESC_ERROR=ADMPV_DESC_ERROR || 'El código de establecimiento no existe o esta de BAJA.',
              ADMPV_COD_ERROR=103
        WHERE ADMPN_FILA=OFER.FILA
            AND ADMPN_CUPONERA=K_ID_CUP;

    END IF;

FETCH OFERTAS INTO OFER;
END LOOP;

CLOSE OFERTAS;

OPEN CUPONES;
FETCH CUPONES INTO V_COD_SEG,V_COD_EST;
WHILE CUPONES%FOUND
LOOP

    OPEN OFERTASCUPON(V_COD_EST,V_COD_SEG);
    FETCH OFERTASCUPON INTO OFER;
    WHILE OFERTASCUPON%FOUND
    LOOP

        V_DES_OFERTA:=V_DES_OFERTA||' '|| OFER.DESC_OFERTA;

    FETCH OFERTASCUPON INTO OFER;
    END LOOP;
    CLOSE OFERTASCUPON;

    V_NUM_LEN:=LENGTH(V_DES_OFERTA);

    IF V_NUM_LEN > V_CARACTER_NUM THEN

        UPDATE PCLUB.ADMPT_TMP_CUPONERA
        SET ADMPV_DESC_ERROR=ADMPV_DESC_ERROR||'Las ofertas sobrepasan el número máximo de caracteres.',
              ADMPV_COD_ERROR=103
        WHERE ADMPN_CUPONERA=K_ID_CUP
        AND ADMPV_COD_EST=V_COD_EST
        AND ADMPV_COD_SEG=V_COD_SEG;

    END IF;

    V_DES_OFERTA:='';

FETCH CUPONES INTO V_COD_SEG,V_COD_EST;
END LOOP;
CLOSE CUPONES;


OPEN OFERTAS_DUPLICADAS;
FETCH OFERTAS_DUPLICADAS INTO OFER.DESC_OFERTA,OFER.CUPON, OFER.CUPONERA, OFER.COD_SEG,OFER.COD_EST,OFER.NRO_REDEN;
WHILE OFERTAS_DUPLICADAS%FOUND
LOOP
   UPDATE ADMPT_TMP_CUPONERA  SET ADMPV_DESC_ERROR='La Oferta se ha Duplicado.', ADMPV_COD_ERROR=104
   WHERE  ADMPN_CUPONERA=K_ID_CUP AND ADMPV_DESC_OFERTA=OFER.DESC_OFERTA AND
          ADMPV_CUPON=OFER.CUPON AND ADMPV_COD_SEG=OFER.COD_SEG AND
          ADMPV_COD_EST = OFER.COD_EST AND (ADMPN_NRO_REDEN=OFER.NRO_REDEN  OR ADMPN_NRO_REDEN IS NULL);

FETCH OFERTAS_DUPLICADAS INTO OFER.DESC_OFERTA,OFER.CUPON, OFER.CUPONERA, OFER.COD_SEG,OFER.COD_EST,OFER.NRO_REDEN;
END LOOP;
CLOSE OFERTAS_DUPLICADAS;


COMMIT;

OPEN K_CUR_CUP FOR
SELECT C.ADMPV_DESC_OFERTA DESC_OFERTA,C.ADMPV_CUPON CUPON,C.ADMPV_COD_SEG COD_SEG,C.ADMPV_COD_EST COD_EST,C.ADMPN_NRO_REDEN REDEN,C.ADMPN_FILA FILA,C.ADMPV_DESC_ERROR OBSERV,'' ACTIVO
FROM PCLUB.ADMPT_TMP_CUPONERA C
WHERE C.ADMPN_CUPONERA=K_ID_CUP
ORDER BY COD_EST,COD_SEG,CUPON;


BEGIN
        SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
        FROM PCLUB.ADMPT_ERRORES_CC
        WHERE ADMPN_COD_ERROR=K_CODERROR;
EXCEPTION WHEN OTHERS THEN
    K_DESCERROR:='';
END;

EXCEPTION
    WHEN EX_ERROR THEN
        BEGIN
                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                FROM PCLUB.ADMPT_ERRORES_CC
                WHERE ADMPN_COD_ERROR=K_CODERROR;
        EXCEPTION WHEN OTHERS THEN
            K_DESCERROR:='';
        END;
        OPEN K_CUR_CUP FOR SELECT '' FROM DUAL WHERE 1=2;
    WHEN OTHERS THEN
            K_CODERROR  := 1;
            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);
            OPEN K_CUR_CUP FOR SELECT '' FROM DUAL WHERE 1=2;
END ADMPSI_VALIDARCUPONERATMP;

PROCEDURE ADMPSI_INSERTARCUPONERA(K_ID_CUP IN NUMBER,K_USUARIO IN VARCHAR2,K_CUR_CUP OUT SYS_REFCURSOR,K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS
TYPE CUPONOFERTA IS RECORD
(
  DESC_OFERTA  VARCHAR2(200),
  CUPON        NUMBER,
  CUPONERA     NUMBER,
  FEC_PROC     DATE,
  USU_REG      VARCHAR2(20),
  COD_ERROR    NUMBER,
  DESC_ERROR   VARCHAR2(300),
  SEQ          NUMBER,
  COD_SEG      VARCHAR2(2),
  COD_EST      VARCHAR2(10),
  NRO_REDEN    NUMBER,
  FILA         NUMBER,
  SEG         NUMBER
);
OFER CUPONOFERTA;
EX_ERROR EXCEPTION;

V_CODSEG_ANT VARCHAR2(2):='-';
V_CODEST_ANT VARCHAR2(10):='-';

CURSOR CUPONES IS
--SELECT T.ADMPN_SEG, T.ADMPV_COD_EST,T.ADMPV_CUPON
--FROM PCLUB.ADMPT_TMP_CUPONERA T
--WHERE T.ADMPN_CUPONERA=K_ID_CUP
--GROUP BY T.ADMPN_SEG, T.ADMPV_COD_EST,T.ADMPV_CUPON
--ORDER BY T.ADMPN_SEG;
SELECT T.ADMPN_SEG, T.ADMPV_COD_EST,T.ADMPV_CUPON--, COUNT(*)
FROM PCLUB.ADMPT_TMP_CUPONERA T
WHERE T.ADMPN_CUPONERA=K_ID_CUP
GROUP BY T.ADMPN_SEG, T.ADMPV_COD_EST,T.ADMPV_CUPON
ORDER BY T.ADMPN_SEG, T.ADMPV_COD_EST;

CURSOR OFERTASCUPON(EST VARCHAR2,SEG NUMBER,CUP NUMBER) IS
SELECT *
FROM PCLUB.ADMPT_TMP_CUPONERA T
WHERE T.ADMPN_CUPONERA=K_ID_CUP
AND T.ADMPV_COD_EST=EST
AND T.ADMPN_SEG=SEG
AND T.ADMPV_CUPON=CUP
ORDER BY T.ADMPV_CUPON;

V_COD_SEG NUMBER;
V_COD_EST VARCHAR2(10);
V_CUP NUMBER;
V_CONT_CUP NUMBER;
V_CONT_OFER NUMBER;
V_COD_CUP VARCHAR2(10);
V_COD_OFER VARCHAR2(3);
V_ID_CUPON NUMBER;

BEGIN
K_CODERROR:=0;
K_DESCERROR:=' ';

    IF K_ID_CUP IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'El código de cuponera no es válido.';
         RAISE EX_ERROR;
    END IF;

UPDATE PCLUB.ADMPT_TMP_CUPONERA T
SET ADMPN_SEG=(SELECT S.ADMPN_COD_SEG  FROM PCLUB.ADMPT_SEGMENTOCUPONERA S WHERE S.ADMPV_DESCRIPCION=T.ADMPV_COD_SEG)
WHERE ADMPN_CUPONERA=K_ID_CUP;


V_CONT_CUP:=0;
V_COD_CUP:='';

V_CONT_OFER:=0;

OPEN CUPONES;
FETCH CUPONES INTO V_COD_SEG,V_COD_EST,V_CUP;
WHILE CUPONES%FOUND
LOOP

    V_COD_CUP:='CUPON'||V_CUP;


    SELECT PCLUB.ADMPT_CUPON_SQ.NEXTVAL  INTO V_ID_CUPON
    FROM DUAL;

    INSERT INTO PCLUB.ADMPT_CUPON(ADMPN_COD_CUPON,ADMPV_DESC_CUPON,ADMPD_FEC_REG,ADMPV_USU_REG,ADMPN_COD_SEG,ADMPV_COD_ESTABL,ADMPN_COD_CUP)
    VALUES(V_ID_CUPON,V_COD_CUP,SYSDATE,K_USUARIO,V_COD_SEG,V_COD_EST,K_ID_CUP);

    OPEN OFERTASCUPON(V_COD_EST,V_COD_SEG,V_CUP);
    FETCH OFERTASCUPON INTO OFER;
    WHILE OFERTASCUPON%FOUND
    LOOP
        IF (V_CODSEG_ANT<>'-' AND V_CODEST_ANT<>'-') AND (V_CODSEG_ANT<>V_COD_SEG OR V_CODEST_ANT<>V_COD_EST) THEN
            V_CONT_OFER:=0;
         END IF;

        V_CONT_OFER:=V_CONT_OFER+1;
        V_COD_OFER:='O'||V_CONT_OFER;

        INSERT INTO PCLUB.ADMPT_OFERTA(ADMPN_COD_OFERTA,ADMPV_NOM_OFERTA,ADMPV_DESCRIPCION,ADMPD_FEC_REG,ADMPV_USU_REG,ADMPN_COD_CUPON,ADMPN_NRO_RED,ADMPN_REDENCIONES,ADMPC_ESTADO)
        VALUES(PCLUB.ADMPT_OFERTA_SQ.NEXTVAL,V_COD_OFER,OFER.DESC_OFERTA,SYSDATE,K_USUARIO,V_ID_CUPON,OFER.NRO_REDEN,OFER.NRO_REDEN,'A');

        /*jcgt*/
         V_CODSEG_ANT:=V_COD_SEG;
         V_CODEST_ANT:=V_COD_EST;

    FETCH OFERTASCUPON INTO OFER;
    END LOOP;
    CLOSE OFERTASCUPON;


FETCH CUPONES INTO V_COD_SEG,V_COD_EST,V_CUP;
END LOOP;
CLOSE CUPONES;

IF V_CONT_OFER <= 0 THEN
     K_CODERROR  := 17;
     K_DESCERROR := 'No se registró ninguna oferta.';
     RAISE EX_ERROR;
END IF;

UPDATE PCLUB.ADMPT_CUPONERA
SET ADMPC_ESTADO='A'
WHERE ADMPN_COD_CUP=K_ID_CUP;

 DELETE FROM PCLUB.ADMPT_TMP_CUPONERA
WHERE ADMPN_CUPONERA=K_ID_CUP;

COMMIT;

OPEN K_CUR_CUP FOR
    SELECT O.ADMPV_DESCRIPCION DESC_OFERTA,C.ADMPV_DESC_CUPON CUPON,S.ADMPV_DESCRIPCION COD_SEG,
    C.ADMPV_COD_ESTABL COD_EST,O.ADMPN_REDENCIONES REDEN, O.ADMPN_COD_OFERTA FILA,'' OBSERV,O.ADMPC_ESTADO ACTIVO
    FROM PCLUB.ADMPT_CUPON C, PCLUB.ADMPT_OFERTA O, PCLUB.ADMPT_CUPONERA CA,PCLUB.ADMPT_SEGMENTOCUPONERA S
    WHERE C.ADMPN_COD_CUPON=O.ADMPN_COD_CUPON
    AND C.ADMPN_COD_CUP=CA.ADMPN_COD_CUP
    AND CA.ADMPN_COD_CUP=K_ID_CUP
    AND S.ADMPN_COD_SEG=C.ADMPN_COD_SEG
    ORDER BY COD_EST,COD_SEG,CUPON;


BEGIN
        SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
        FROM PCLUB.ADMPT_ERRORES_CC
        WHERE ADMPN_COD_ERROR=K_CODERROR;
EXCEPTION WHEN OTHERS THEN
    K_DESCERROR:='';
END;

EXCEPTION
    WHEN EX_ERROR THEN
        ROLLBACK;
        BEGIN
                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                FROM PCLUB.ADMPT_ERRORES_CC
                WHERE ADMPN_COD_ERROR=K_CODERROR;
        EXCEPTION WHEN OTHERS THEN
            K_DESCERROR:='';
        END;
        OPEN K_CUR_CUP FOR SELECT '' FROM DUAL WHERE 1=2;
    WHEN OTHERS THEN
            K_CODERROR  := 1;
            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);
            OPEN K_CUR_CUP FOR SELECT '' FROM DUAL WHERE 1=2;
END ADMPSI_INSERTARCUPONERA;

PROCEDURE ADMPSI_ACTOFERTA(K_ID_CUP IN NUMBER,K_ID_OFER IN NUMBER,K_ESTADO IN VARCHAR2,K_USUARIO IN VARCHAR2,K_CUR_CUP OUT SYS_REFCURSOR,K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS
EX_ERROR EXCEPTION;
BEGIN

K_CODERROR:=0;
K_DESCERROR:=' ';

   IF K_ID_CUP IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'El código de cuponera no es válido.';
         RAISE EX_ERROR;
  END IF;

  IF K_ID_OFER IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'El código de oferta no es válido.';
         RAISE EX_ERROR;
  END IF;

 UPDATE PCLUB.ADMPT_OFERTA
 SET ADMPC_ESTADO=K_ESTADO,
       ADMPV_USU_MOD=K_USUARIO,
       ADMPD_FEC_MOD=SYSDATE
 WHERE ADMPN_COD_OFERTA=K_ID_OFER;

     OPEN K_CUR_CUP FOR
    SELECT O.ADMPV_DESCRIPCION DESC_OFERTA,C.ADMPV_DESC_CUPON CUPON,S.ADMPV_DESCRIPCION COD_SEG,
    C.ADMPV_COD_ESTABL COD_EST,O.ADMPN_REDENCIONES REDEN, O.ADMPN_COD_OFERTA FILA,'' OBSERV,O.ADMPC_ESTADO ACTIVO
    FROM PCLUB.ADMPT_CUPON C, PCLUB.ADMPT_OFERTA O, PCLUB.ADMPT_CUPONERA CA,PCLUB.ADMPT_SEGMENTOCUPONERA S
    WHERE C.ADMPN_COD_CUPON=O.ADMPN_COD_CUPON
    AND C.ADMPN_COD_CUP=CA.ADMPN_COD_CUP
    AND CA.ADMPN_COD_CUP=K_ID_CUP
    AND S.ADMPN_COD_SEG=C.ADMPN_COD_SEG
    ORDER BY COD_EST,COD_SEG,CUPON;

BEGIN
        SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
        FROM PCLUB.ADMPT_ERRORES_CC
        WHERE ADMPN_COD_ERROR=K_CODERROR;
EXCEPTION WHEN OTHERS THEN
    K_DESCERROR:='';
END;

EXCEPTION
    WHEN EX_ERROR THEN
        BEGIN
                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                FROM PCLUB.ADMPT_ERRORES_CC
                WHERE ADMPN_COD_ERROR=K_CODERROR;
        EXCEPTION WHEN OTHERS THEN
            K_DESCERROR:='';
        END;
    WHEN OTHERS THEN
            K_CODERROR  := 1;
            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);
END ADMPSI_ACTOFERTA;

 PROCEDURE ADMPSI_REPORTACUPONERA(K_ID_CUP IN NUMBER,K_USUARIO IN VARCHAR2,K_CUR_CUP OUT SYS_REFCURSOR,K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS
 EX_ERROR EXCEPTION;
BEGIN

K_CODERROR:=0;
K_DESCERROR:=' ';

  IF K_ID_CUP IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'El código de cuponera no es válido.';
         RAISE EX_ERROR;
  END IF;

 OPEN K_CUR_CUP FOR
    SELECT O.ADMPV_DESCRIPCION DESC_OFERTA,C.ADMPV_DESC_CUPON CUPON,S.ADMPV_DESCRIPCION COD_SEG,
    C.ADMPV_COD_ESTABL COD_EST,O.ADMPN_REDENCIONES REDEN, O.ADMPN_COD_OFERTA FILA,'' OBSERV,O.ADMPC_ESTADO ACTIVO
    FROM PCLUB.ADMPT_CUPON C, PCLUB.ADMPT_OFERTA O, PCLUB.ADMPT_CUPONERA CA,PCLUB.ADMPT_SEGMENTOCUPONERA S
    WHERE C.ADMPN_COD_CUPON=O.ADMPN_COD_CUPON
    AND C.ADMPN_COD_CUP=CA.ADMPN_COD_CUP
    AND CA.ADMPN_COD_CUP=K_ID_CUP
    AND S.ADMPN_COD_SEG=C.ADMPN_COD_SEG
    ORDER BY COD_EST, COD_SEG, CUPON;

BEGIN
        SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
        FROM PCLUB.ADMPT_ERRORES_CC
        WHERE ADMPN_COD_ERROR=K_CODERROR;
EXCEPTION WHEN OTHERS THEN
    K_DESCERROR:='';
END;

EXCEPTION
    WHEN EX_ERROR THEN
        BEGIN
                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                FROM PCLUB.ADMPT_ERRORES_CC
                WHERE ADMPN_COD_ERROR=K_CODERROR;
        EXCEPTION WHEN OTHERS THEN
            K_DESCERROR:='';
        END;
    WHEN OTHERS THEN
            K_CODERROR  := 1;
            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);
 END ADMPSI_REPORTACUPONERA;

PROCEDURE ADMPSI_CONSULTACUP(K_NUM_DOC IN VARCHAR2,K_NUM_MOVIL IN VARCHAR2,K_COD_EST IN VARCHAR2,K_USUARIO IN VARCHAR2,K_RESP_SMS OUT VARCHAR2,K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS

EX_ERROR EXCEPTION;
V_COD_EST VARCHAR2(10);
V_CONT_CLI NUMBER;
V_CONT_CON NUMBER;
V_CONT_BLOQ NUMBER;
V_ULT_CON DATE;
V_COD_SEG NUMBER;
V_DES_MSJE VARCHAR2(200);
V_NRO_REDEN NUMBER;
V_COD_CUP NUMBER;
V_COD_OFER NUMBER;
V_NOM_OFER VARCHAR2(10);
V_ITER NUMBER;
V_TIPDOC VARCHAR2(20);
V_LEN_NUMDOC NUMBER;
V_TI_BLOQ NUMBER;
V_TI_CON NUMBER;
V_TIE_BLOQ NUMBER;
V_TIE_CON NUMBER;


V_MSJE_FIN VARCHAR2(200);
K_CUR_OFER SYS_REFCURSOR;
V_RESPUESTA NUMBER;
V_DESERROR VARCHAR2(250);
V_CONTPRE NUMBER;
V_CONTNOPRE NUMBER;
V_CONT_OFER NUMBER;
V_NRO_INTENTOS NUMBER;

V_COD_CLI NUMBER;

V_REDENCIONES NUMBER;--JCGT2910
V_ESTADO_EST VARCHAR2(2);
V_CONT_CUP NUMBER;
V_CONT_EST NUMBER;

BEGIN
K_CODERROR:=0;
K_DESCERROR:=' ';
--K_RESPUESTA:='';




 IF K_NUM_DOC IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'El Nro de Dcto. es obligatorio. ';
         PCLUB.PKG_CC_MANTENIMIENTO.ADMPSI_OBTMENSAJE('REGDOCNOVALIDO', K_RESP_SMS, V_RESPUESTA,V_DESERROR);
         RAISE EX_ERROR;
 ELSE
        V_LEN_NUMDOC:=LENGTH(TRIM(K_NUM_DOC));
        IF V_LEN_NUMDOC = 8 THEN
            V_TIPDOC:='2';
        ELSE
            V_TIPDOC:='4';
        END IF;
 END IF;

 IF K_NUM_MOVIL IS NULL THEN
        K_CODERROR  := 4;
        K_DESCERROR := 'Es obligatorio enviar el numero movil.';
        PCLUB.PKG_CC_MANTENIMIENTO.ADMPSI_OBTMENSAJE('REGERROROPERACION', K_RESP_SMS, V_RESPUESTA,V_DESERROR);
        RAISE EX_ERROR;
 END IF;

  IF K_COD_EST IS NULL THEN
         --BEGIN

           SELECT COUNT(*) INTO V_CONT_EST
            FROM PCLUB.ADMPT_TELEFONOCUPONERA T, PCLUB.ADMPT_ESTABLECIMIENTO E
            WHERE T.ADMPV_NUM_TELEFONO = K_NUM_MOVIL
            AND T.ADMPV_COD_ESTABL=E.ADMPV_COD_ESTABL
            AND E.ADMPV_ESTADO='A';

            IF V_CONT_EST=0 THEN
               K_CODERROR  :=14;
               K_DESCERROR := 'El establecimiento se encuentra de baja o no existe. ';
               PCLUB.PKG_CC_MANTENIMIENTO.ADMPSI_OBTMENSAJE('REGESTABAJA', K_RESP_SMS, V_RESPUESTA,V_DESERROR);
               RAISE EX_ERROR;
            END IF;

            SELECT T.ADMPV_COD_ESTABL,E.ADMPV_ESTADO INTO V_COD_EST, V_ESTADO_EST
            FROM PCLUB.ADMPT_TELEFONOCUPONERA T, PCLUB.ADMPT_ESTABLECIMIENTO E
            WHERE T.ADMPV_NUM_TELEFONO = K_NUM_MOVIL
            AND T.ADMPV_COD_ESTABL=E.ADMPV_COD_ESTABL
            AND E.ADMPV_ESTADO='A';
            /*SELECT T.ADMPV_COD_ESTABL,E.ADMPV_ESTADO INTO V_COD_EST, V_ESTADO_EST
            FROM PCLUB.ADMPT_TELEFONOCUPONERA T, PCLUB.ADMPT_ESTABLECIMIENTO E
            WHERE T.ADMPV_NUM_TELEFONO = K_NUM_MOVIL
            AND T.ADMPV_COD_ESTABL=E.ADMPV_COD_ESTABL;

            IF V_ESTADO_EST='B' THEN
               K_CODERROR  :=14;
               K_DESCERROR := 'El establecimiento se encuentra de baja. ';
               PCLUB.PKG_CC_MANTENIMIENTO.ADMPSI_OBTMENSAJE('REGESTABAJA', K_RESP_SMS, V_RESPUESTA,V_DESERROR);
               RAISE EX_ERROR;
            END IF;*/


        /*EXCEPTION
            WHEN NO_DATA_FOUND THEN
             K_CODERROR  :=14;
             K_DESCERROR := 'No existe un establecimiento asociado a la linea y no se envió el código de establecimiento . ';
             PCLUB.PKG_CC_MANTENIMIENTO.ADMPSI_OBTMENSAJE('REGESTERROR', K_RESP_SMS, V_RESPUESTA,V_DESERROR);
             RAISE EX_ERROR;

            WHEN OTHERS THEN
             K_CODERROR  :=14;
             K_DESCERROR := 'Error en la relacion TELEFONO - ESTABLECIMIENTO ';
             PCLUB.PKG_CC_MANTENIMIENTO.ADMPSI_OBTMENSAJE('REGERROROPERACION', K_RESP_SMS, V_RESPUESTA,V_DESERROR);
             RAISE EX_ERROR;
        END;*/
  ELSE
        SELECT COUNT(*) INTO V_CONT_EST
        FROM PCLUB.ADMPT_ESTABLECIMIENTO E
        WHERE E.ADMPV_COD_ESTABL=K_COD_EST
        AND E.ADMPV_ESTADO='A';

        IF V_CONT_EST=0 THEN
               K_CODERROR  :=14;
               K_DESCERROR := 'El establecimiento se encuentra de baja o no existe. ';
               PCLUB.PKG_CC_MANTENIMIENTO.ADMPSI_OBTMENSAJE('REGESTABAJA', K_RESP_SMS, V_RESPUESTA,V_DESERROR);
               RAISE EX_ERROR;
        END IF;

        SELECT E.ADMPV_COD_ESTABL,E.ADMPV_ESTADO INTO V_COD_EST, V_ESTADO_EST
        FROM PCLUB.ADMPT_ESTABLECIMIENTO E
        WHERE E.ADMPV_COD_ESTABL=K_COD_EST
        AND E.ADMPV_ESTADO='A';

        /*BEGIN
                SELECT E.ADMPV_COD_ESTABL,E.ADMPV_ESTADO INTO V_COD_EST, V_ESTADO_EST
                FROM PCLUB.ADMPT_ESTABLECIMIENTO E
                WHERE E.ADMPV_COD_ESTABL=K_COD_EST;

               IF V_ESTADO_EST='B' THEN
                 K_CODERROR  :=14;
                 K_DESCERROR := 'El establecimiento se encuentra de baja. ';
                 PCLUB.PKG_CC_MANTENIMIENTO.ADMPSI_OBTMENSAJE('REGESTABAJA', K_RESP_SMS, V_RESPUESTA,V_DESERROR);
                 RAISE EX_ERROR;
               END IF;

        EXCEPTION
            WHEN NO_DATA_FOUND THEN
                PCLUB.PKG_CC_MANTENIMIENTO.ADMPSI_OBTMENSAJE('REGESTERROR', K_RESP_SMS, V_RESPUESTA,V_DESERROR);
                 K_CODERROR  :=14;
                 K_DESCERROR := K_RESP_SMS;
                 RAISE EX_ERROR;
            WHEN OTHERS THEN
                PCLUB.PKG_CC_MANTENIMIENTO.ADMPSI_OBTMENSAJE('REGERROROPERACION', K_RESP_SMS, V_RESPUESTA,V_DESERROR);
                 K_CODERROR  :=14;
                 K_DESCERROR := 'Error en el código de establecmiento. ';
                 RAISE EX_ERROR;
        END;*/
         --V_COD_EST:=K_COD_EST;
  END IF;

-- IF K_COD_EST IS NULL THEN
--    IF K_NUM_MOVIL IS NULL THEN
--         K_CODERROR  := 4;
--         K_DESCERROR := 'Es obligatorio enviar el numero movil o el código de establecimiento. ';
--         RAISE EX_ERROR;
--    ELSE
--
--        BEGIN
--
--            SELECT T.ADMPV_COD_ESTABL INTO V_COD_EST
--            FROM PCLUB.ADMPT_TELEFONOCUPONERA T
--            WHERE T.ADMPV_NUM_TELEFONO = K_NUM_MOVIL;
--
--        EXCEPTION
--            WHEN NO_DATA_FOUND THEN
--             K_CODERROR  :=14;
--             K_DESCERROR := ' ';
--             RAISE EX_ERROR;
--
--            WHEN OTHERS THEN
--             K_CODERROR  :=14;
--             K_DESCERROR := ' ';
--             RAISE EX_ERROR;
--        END;
--
--    END IF;
-- ELSE
--    V_COD_EST:=K_COD_EST;
-- END IF;

 BEGIN

    SELECT TO_NUMBER(ADMPV_VALOR) INTO V_NRO_INTENTOS
    FROM PCLUB.ADMPT_PARAMSIST
    WHERE ADMPV_DESC = 'NRO_INTENTO_BLOQ';

    SELECT ADMPV_VALOR INTO V_MSJE_FIN
    FROM PCLUB.ADMPT_PARAMSIST
    WHERE ADMPV_DESC = 'ENTRADA_OFERTAS_CUPONERA';

    SELECT TO_NUMBER(ADMPV_VALOR) INTO V_TI_BLOQ
    FROM PCLUB.ADMPT_PARAMSIST
    WHERE ADMPV_DESC = 'TIEMPO_BLOQUEO_CUPONERA';

    SELECT TO_NUMBER(ADMPV_VALOR) INTO V_TI_CON
    FROM PCLUB.ADMPT_PARAMSIST
    WHERE ADMPV_DESC = 'TIEMPO_CONSULTA_CUPONERA';

    V_TIE_BLOQ:=V_TI_BLOQ/1440;
    V_TIE_CON:=V_TI_CON/1440;

 EXCEPTION
            WHEN NO_DATA_FOUND THEN
             K_CODERROR  :=14;
             K_DESCERROR := 'PARAMETROS: "NRO_INTENTO_BLOQ","ENTRADA_OFERTAS_CUPONERA","TIEMPO_BLOQUEO_CUPONERA" y "TIEMPO_CONSULTA_CUPONERA"  ';
             PCLUB.PKG_CC_MANTENIMIENTO.ADMPSI_OBTMENSAJE('REGERROROPERACION', K_RESP_SMS, V_RESPUESTA,V_DESERROR);
             RAISE EX_ERROR;
 END;


 SELECT COUNT(C.ADMPN_COD_CLI) INTO V_CONT_CLI
 FROM PCLUB.ADMPT_CLIENTECUPONERA C
 WHERE C.ADMPV_NUM_DOC = UPPER(K_NUM_DOC)
 AND C.ADMPV_TIPO_DOC = V_TIPDOC
 AND C.ADMPC_ESTADO = 'A';

 IF V_CONT_CLI > 0 THEN

     SELECT COUNT(C.ADMPN_COD_CLI) INTO V_CONT_CLI
     FROM PCLUB.ADMPT_CLIENTECUPONERA C
     WHERE C.ADMPV_NUM_DOC = UPPER(K_NUM_DOC)
     AND C.ADMPV_TIPO_DOC = V_TIPDOC
     AND C.ADMPC_ESTADO = 'A'
     AND C.ADMPV_ESTADO_CON = 'A';

     SELECT C.ADMPN_COD_CLI INTO V_COD_CLI
     FROM PCLUB.ADMPT_CLIENTECUPONERA C
     WHERE C.ADMPV_NUM_DOC = UPPER(K_NUM_DOC)
     AND C.ADMPV_TIPO_DOC = V_TIPDOC
     AND C.ADMPC_ESTADO = 'A';

      IF V_CONT_CLI = 0 THEN

        BEGIN
              SELECT FEC_CON INTO V_ULT_CON
              FROM(SELECT C.ADMPV_FEC_CON FEC_CON
                     FROM PCLUB.ADMPT_CONSULTACUPONERA C
                     WHERE C.ADMPN_COD_CLI = V_COD_CLI
                     ORDER BY C.ADMPV_FEC_CON DESC)
              WHERE ROWNUM=1;

        EXCEPTION
            WHEN NO_DATA_FOUND THEN
             K_CODERROR  :=14;
             K_DESCERROR := ' ';
             PCLUB.PKG_CC_MANTENIMIENTO.ADMPSI_OBTMENSAJE('REGERROROPERACION', K_RESP_SMS, V_RESPUESTA,V_DESERROR);
             RAISE EX_ERROR;
        END;

        IF V_ULT_CON <=SYSDATE AND V_ULT_CON>=(SYSDATE - V_TIE_BLOQ) THEN
             K_CODERROR  :=29;
             K_DESCERROR := 'Cliente se encuentra bloqueado por consultar mas de '||V_NRO_INTENTOS||' veces en '||V_TI_CON||' minutos.';
             PCLUB.PKG_CC_MANTENIMIENTO.ADMPSI_OBTMENSAJE('REGCONSULTAEERROR', K_RESP_SMS, V_RESPUESTA,V_DESERROR);--ERROR CUANDO ESTA BLOQUEADO
             RAISE EX_ERROR;
        ELSE
            UPDATE PCLUB.ADMPT_CLIENTECUPONERA
            SET ADMPV_ESTADO_CON = 'A'
            WHERE ADMPN_COD_CLI = V_COD_CLI;

        END IF;

      ELSE
         SELECT COUNT(ADMPV_NUM_MOVIL) INTO V_CONT_CON
         FROM PCLUB.ADMPT_CONSULTACUPONERA C
         WHERE C.ADMPN_COD_CLI = V_COD_CLI
         AND ADMPV_FEC_CON BETWEEN (SYSDATE - V_TIE_CON) AND  SYSDATE;

         IF V_CONT_CON >= V_NRO_INTENTOS THEN

            UPDATE PCLUB.ADMPT_CLIENTECUPONERA
            SET ADMPV_ESTADO_CON = 'B'
            WHERE ADMPN_COD_CLI = V_COD_CLI;

            COMMIT;
            K_CODERROR  :=29;
            K_DESCERROR := 'Cliente se encuentra bloqueado por consultar mas de '||V_NRO_INTENTOS||' veces en '||V_TI_CON||' minutos.';
            PCLUB.PKG_CC_MANTENIMIENTO.ADMPSI_OBTMENSAJE('REGCONSULTAEERROR', K_RESP_SMS, V_RESPUESTA,V_DESERROR);--ERROR CUANDO ESTA BLOQUEADO
            RAISE EX_ERROR;

         END IF;

      END IF;

 ELSE

    IF V_TIPDOC = '2' THEN
        V_TIPDOC := 'DNI';
    ELSE
        V_TIPDOC := 'Carnet Extranjería';
    END IF;

    select COUNT(*) INTO V_CONTNOPRE
    from dm.ods_base_abonados@dbl_reptdm_d T
    WHERE T.TIPO_DOCUMENTO = V_TIPDOC
    AND T.NRO_DOCUMENTO = K_NUM_DOC
    AND T.IDSEGMENTO <> 1;

    select COUNT(*) INTO V_CONTPRE
    from dm.ods_base_abonados@dbl_reptdm_d T
    WHERE T.TIPO_DOCUMENTO = V_TIPDOC
    AND T.NRO_DOCUMENTO = K_NUM_DOC
    AND T.IDSEGMENTO = 1;

    IF V_CONTNOPRE = 0 THEN
        IF V_CONTPRE <> 0 THEN
             K_CODERROR  := 6;
             K_DESCERROR := 'El Nro de Dcto. ingresado no esta registrado  como cliente o se encuentra de BAJA. ';
             PCLUB.PKG_CC_MANTENIMIENTO.ADMPSI_OBTMENSAJE('REGCLIEPRENOVALIDO', K_RESP_SMS, V_RESPUESTA,V_DESERROR);
             K_RESP_SMS:= K_NUM_DOC || ' ' || K_RESP_SMS;
             RAISE EX_ERROR;
        END IF;
    END IF;

     K_CODERROR  := 6;
     K_DESCERROR := 'El Nro de Dcto. ingresado no esta registrado  como cliente o se encuentra de BAJA. ';
     PCLUB.PKG_CC_MANTENIMIENTO.ADMPSI_OBTMENSAJE('REGDOCNOVALIDO', K_RESP_SMS, V_RESPUESTA,V_DESERROR);
     K_RESP_SMS:= K_NUM_DOC || ' ' || K_RESP_SMS;
     RAISE EX_ERROR;

 END IF;

 SELECT C.ADMPN_COD_SEG INTO V_COD_SEG
 FROM  PCLUB.ADMPT_CLIENTECUPONERA C
 WHERE C.ADMPN_COD_CLI = V_COD_CLI
 AND C.ADMPV_ESTADO_CON = 'A';

    SELECT COUNT(*) INTO V_CONT_CUP
    FROM PCLUB.ADMPT_CUPONERA CA
    WHERE (CA.ADMPD_FEC_INI <= SYSDATE AND CA.ADMPD_FEC_FIN >= SYSDATE);

    IF V_CONT_CUP=0 THEN
        PCLUB.PKG_CC_MANTENIMIENTO.ADMPSI_OBTMENSAJE('REGCADUCAOFERTA', K_RESP_SMS, V_RESPUESTA,V_DESERROR);
        INSERT INTO PCLUB.ADMPT_CONSULTACUPONERA VALUES(K_NUM_MOVIL,V_COD_CLI,V_COD_EST,SYSDATE,K_RESP_SMS,
                                                        K_USUARIO,SYSDATE,V_TIPDOC,V_COD_SEG,PCLUB.ADMPT_CONSULTACUP_SQ.NEXTVAL);
        COMMIT;
        K_CODERROR  := 6;
        K_DESCERROR := 'La cuponera ya caduco. ';
        RAISE EX_ERROR;
    END IF;

    OPEN K_CUR_OFER FOR
    --SELECT O.ADMPN_COD_CUPON,O.ADMPN_COD_OFERTA,O.ADMPV_NOM_OFERTA,O.ADMPV_DESCRIPCION,O.ADMPN_NRO_RED-- JCGT 2910
    SELECT O.ADMPN_COD_CUPON,O.ADMPN_COD_OFERTA,O.ADMPV_NOM_OFERTA,O.ADMPV_DESCRIPCION,O.ADMPN_NRO_RED,O.ADMPN_REDENCIONES
    FROM PCLUB.ADMPT_CUPON C, PCLUB.ADMPT_OFERTA O, PCLUB.ADMPT_CUPONERA CA
    WHERE C.ADMPN_COD_CUPON=O.ADMPN_COD_CUPON
    AND C.ADMPN_COD_CUP=CA.ADMPN_COD_CUP
    AND C.ADMPV_COD_ESTABL= V_COD_EST
    AND C.ADMPN_COD_SEG = V_COD_SEG
    AND CA.ADMPC_ESTADO='A'
    AND O.ADMPC_ESTADO='A'
    AND (CA.ADMPD_FEC_INI <= SYSDATE AND CA.ADMPD_FEC_FIN >= SYSDATE);
    --AND O.ADMPN_NRO_RED > 0;

    /*JCGT INI PARA CREAR EL MENSAJE*/
    V_ITER:=0;
    V_CONT_OFER:=0;

    FETCH K_CUR_OFER INTO V_COD_CUP,V_COD_OFER,V_NOM_OFER,V_DES_MSJE,V_NRO_REDEN,V_REDENCIONES;
     WHILE K_CUR_OFER%FOUND LOOP
        V_ITER:=V_ITER+1;
        IF (V_REDENCIONES IS NOT NULL AND V_NRO_REDEN > 0) OR V_REDENCIONES IS NULL THEN
            V_CONT_OFER:=V_CONT_OFER+1;
            V_MSJE_FIN:=V_MSJE_FIN || '|' || V_NOM_OFER || ':' || V_DES_MSJE;--CHR(10);
        END IF;
     FETCH K_CUR_OFER INTO V_COD_CUP,V_COD_OFER,V_NOM_OFER,V_DES_MSJE,V_NRO_REDEN,V_REDENCIONES;
     END LOOP;

    IF  V_ITER = 0 THEN
        PCLUB.PKG_CC_MANTENIMIENTO.ADMPSI_OBTMENSAJE('REGNOOFERTAACT', K_RESP_SMS, V_RESPUESTA,V_DESERROR);
        INSERT INTO PCLUB.ADMPT_CONSULTACUPONERA VALUES(K_NUM_MOVIL,V_COD_CLI,V_COD_EST,SYSDATE,K_RESP_SMS,
                                                        K_USUARIO,SYSDATE,V_TIPDOC,V_COD_SEG,PCLUB.ADMPT_CONSULTACUP_SQ.NEXTVAL);
        COMMIT;
        K_CODERROR  := 6;
        K_DESCERROR := 'No hay ofertas disponibles. ';
        RAISE EX_ERROR;
    END IF;

    IF V_CONT_OFER > 0 THEN
         INSERT INTO PCLUB.ADMPT_CONSULTACUPONERA VALUES(K_NUM_MOVIL,V_COD_CLI,V_COD_EST,SYSDATE,V_MSJE_FIN,
                                                        K_USUARIO,SYSDATE,V_TIPDOC,V_COD_SEG,PCLUB.ADMPT_CONSULTACUP_SQ.NEXTVAL);
         --PCLUB.PKG_CC_MANTENIMIENTO.ADMPSI_OBTMENSAJE('REGERROROPERACION', K_RESP_SMS, V_RESPUESTA,V_DESERROR);
    ELSE
        PCLUB.PKG_CC_MANTENIMIENTO.ADMPSI_OBTMENSAJE('REGOFERTACADUCA', V_MSJE_FIN, V_RESPUESTA,V_DESERROR);
        INSERT INTO PCLUB.ADMPT_CONSULTACUPONERA VALUES(K_NUM_MOVIL,V_COD_CLI,V_COD_EST,SYSDATE,V_MSJE_FIN,
                                                            K_USUARIO,SYSDATE,V_TIPDOC,V_COD_SEG,PCLUB.ADMPT_CONSULTACUP_SQ.NEXTVAL);

    END IF;

    K_RESP_SMS:=TRIM(V_MSJE_FIN);
    /*JCGT FIN PARA CREAR EL MENSAJE*/
COMMIT;
BEGIN
        SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
        FROM PCLUB.ADMPT_ERRORES_CC
        WHERE ADMPN_COD_ERROR=K_CODERROR;
EXCEPTION WHEN OTHERS THEN
    K_DESCERROR:='';
END;

EXCEPTION
    WHEN EX_ERROR THEN
        --COMMIT;
        BEGIN
                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                FROM PCLUB.ADMPT_ERRORES_CC
                WHERE ADMPN_COD_ERROR=K_CODERROR;
        EXCEPTION WHEN OTHERS THEN
            K_DESCERROR:='';
        END;
    WHEN OTHERS THEN
            ROLLBACK;
            K_CODERROR  := 1;
            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);
            PCLUB.PKG_CC_MANTENIMIENTO.ADMPSI_OBTMENSAJE('REGERROROPERACION', K_RESP_SMS, V_RESPUESTA,V_DESERROR);
END ADMPSI_CONSULTACUP;


PROCEDURE ADMPSI_MOVIMCUP(K_NUM_DOC IN VARCHAR2,K_NUM_MOVIL IN VARCHAR2,K_COD_EST IN VARCHAR2,K_NUM_OFER IN VARCHAR2,K_USUARIO IN VARCHAR2,K_RESP_SMS OUT VARCHAR2,
K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS

EX_ERROR EXCEPTION;
V_COD_EST VARCHAR2(10);
V_CONT_CLI NUMBER;
V_CONT_CON NUMBER;
V_CONT_BLOQ NUMBER;
V_ULT_CON DATE;
V_COD_SEG NUMBER;
V_DES_MSJE VARCHAR2(200);

V_TIPDOC VARCHAR2(20);
V_LEN_NUMDOC NUMBER;

V_COD_OFER NUMBER;
V_NUM_RED NUMBER;
V_ITER NUMBER;
V_COD_CUPON NUMBER;
V_COD_CUPONERA NUMBER;

V_MSJE_FIN VARCHAR2(200);
V_RESPUESTA NUMBER;
V_DESERROR VARCHAR2(250);
V_CONTPRE NUMBER;
V_CONTNOPRE NUMBER;

V_COD_CLI NUMBER;
V_NUM_OFER VARCHAR2(5);

BEGIN
K_CODERROR:=0;
K_DESCERROR:=' ';
--K_RESPUESTA:='';

  IF K_NUM_DOC IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'El Nro de Dcto. es obligatorio. ';
         PCLUB.PKG_CC_MANTENIMIENTO.ADMPSI_OBTMENSAJE('REGDOCNOVALIDO', K_RESP_SMS, V_RESPUESTA,V_DESERROR);
         RAISE EX_ERROR;
 ELSE
        V_LEN_NUMDOC:=LENGTH(TRIM(K_NUM_DOC));
        IF V_LEN_NUMDOC = 8 THEN
            V_TIPDOC:='2';
        ELSE
            V_TIPDOC:='4';
        END IF;
 END IF;

  IF K_NUM_OFER IS NULL THEN
         K_CODERROR  := 4;
         K_DESCERROR := 'El Nro de oferta es obligatorio. ';
         PCLUB.PKG_CC_MANTENIMIENTO.ADMPSI_OBTMENSAJE('REGOFERCLAVEERROR', K_RESP_SMS, V_RESPUESTA,V_DESERROR);
         RAISE EX_ERROR;
 END IF;
V_NUM_OFER:=UPPER(K_NUM_OFER);

 IF K_NUM_MOVIL IS NULL THEN
        K_CODERROR  := 4;
        K_DESCERROR := 'Es obligatorio enviar el numero movil.';
        PCLUB.PKG_CC_MANTENIMIENTO.ADMPSI_OBTMENSAJE('REGERROROPERACION', K_RESP_SMS, V_RESPUESTA,V_DESERROR);
        RAISE EX_ERROR;
 END IF;

  IF K_COD_EST IS NULL THEN
         BEGIN

            SELECT T.ADMPV_COD_ESTABL INTO V_COD_EST
            FROM PCLUB.ADMPT_TELEFONOCUPONERA T
            WHERE T.ADMPV_NUM_TELEFONO = K_NUM_MOVIL;

        EXCEPTION
            WHEN NO_DATA_FOUND THEN
             K_CODERROR  :=14;
             K_DESCERROR := 'No existe un establecimiento asociado a la linea y no se envió el código de establecimiento . ';
             PCLUB.PKG_CC_MANTENIMIENTO.ADMPSI_OBTMENSAJE('REGESTERROR', K_RESP_SMS, V_RESPUESTA,V_DESERROR);
             RAISE EX_ERROR;

            WHEN OTHERS THEN
             K_CODERROR  :=14;
             K_DESCERROR := 'Error en la relacion TELEFONO - ESTABLECIMIENTO ';
             PCLUB.PKG_CC_MANTENIMIENTO.ADMPSI_OBTMENSAJE('REGERROROPERACION', K_RESP_SMS, V_RESPUESTA,V_DESERROR);
             RAISE EX_ERROR;
        END;
  ELSE
        BEGIN
                SELECT E.ADMPV_COD_ESTABL INTO V_COD_EST
                FROM PCLUB.ADMPT_ESTABLECIMIENTO E
                WHERE E.ADMPV_COD_ESTABL=K_COD_EST;

        EXCEPTION
            WHEN NO_DATA_FOUND THEN
                PCLUB.PKG_CC_MANTENIMIENTO.ADMPSI_OBTMENSAJE('REGESTERROR', K_RESP_SMS, V_RESPUESTA,V_DESERROR);
                 K_CODERROR  :=14;
                 K_DESCERROR := K_RESP_SMS;
                 RAISE EX_ERROR;
            WHEN OTHERS THEN
                PCLUB.PKG_CC_MANTENIMIENTO.ADMPSI_OBTMENSAJE('REGERROROPERACION', K_RESP_SMS, V_RESPUESTA,V_DESERROR);
                 K_CODERROR  :=14;
                 K_DESCERROR := 'Error en el código de establecmiento. ';
                 RAISE EX_ERROR;
        END;
         --V_COD_EST:=K_COD_EST;
  END IF;
-- IF K_COD_EST IS NULL THEN
--    IF K_NUM_MOVIL IS NULL THEN
--         K_CODERROR  := 4;
--         K_DESCERROR := 'Es obligatorio enviar el numero movil o el código de establecimiento. ';
--         RAISE EX_ERROR;
--    ELSE
--        BEGIN
--
--            SELECT T.ADMPV_COD_ESTABL INTO V_COD_EST
--            FROM PCLUB.ADMPT_TELEFONOCUPONERA T
--            WHERE T.ADMPV_NUM_TELEFONO = K_NUM_MOVIL;
--
--        EXCEPTION
--            WHEN NO_DATA_FOUND THEN
--             K_CODERROR  :=14;
--             K_DESCERROR := ' ';
--             RAISE EX_ERROR;
--
--            WHEN OTHERS THEN
--             K_CODERROR  :=14;
--             K_DESCERROR := ' ';
--             RAISE EX_ERROR;
--        END;
--    END IF;
-- ELSE
--    V_COD_EST:=K_COD_EST;
-- END IF;

 SELECT COUNT(C.ADMPN_COD_CLI) INTO V_CONT_CLI
 FROM PCLUB.ADMPT_CLIENTECUPONERA C
 WHERE C.ADMPV_NUM_DOC = UPPER(K_NUM_DOC)
 AND C.ADMPV_TIPO_DOC = V_TIPDOC
 AND C.ADMPC_ESTADO = 'A';

 IF V_CONT_CLI > 0 THEN

     SELECT C.ADMPN_COD_SEG,C.ADMPN_COD_CLI INTO V_COD_SEG,V_COD_CLI
     FROM  PCLUB.ADMPT_CLIENTECUPONERA C
     WHERE C.ADMPV_NUM_DOC = UPPER(K_NUM_DOC)
     AND C.ADMPV_TIPO_DOC = V_TIPDOC
     AND C.ADMPC_ESTADO = 'A';

    BEGIN

            SELECT CA.ADMPN_COD_CUP,C.ADMPN_COD_CUPON, O.ADMPN_COD_OFERTA,O.ADMPN_NRO_RED INTO V_COD_CUPONERA,V_COD_CUPON,V_COD_OFER,V_NUM_RED
            FROM PCLUB.ADMPT_CUPON C, PCLUB.ADMPT_OFERTA O, PCLUB.ADMPT_CUPONERA CA
            WHERE C.ADMPN_COD_CUPON=O.ADMPN_COD_CUPON
            AND C.ADMPN_COD_CUP=CA.ADMPN_COD_CUP
            AND C.ADMPV_COD_ESTABL= V_COD_EST
            AND C.ADMPN_COD_SEG = V_COD_SEG
            AND CA.ADMPC_ESTADO='A'
            AND O.ADMPC_ESTADO='A'
            AND O.ADMPV_NOM_OFERTA=V_NUM_OFER
            AND (CA.ADMPD_FEC_INI <= SYSDATE AND CA.ADMPD_FEC_FIN >= SYSDATE);

            IF V_NUM_RED = 0 THEN
                    K_CODERROR  :=30;
                    K_DESCERROR := ' ';
                    PCLUB.PKG_CC_MANTENIMIENTO.ADMPSI_OBTMENSAJE('REGOFERTACADUCA', K_RESP_SMS, V_RESPUESTA,V_DESERROR);
                    RAISE EX_ERROR;
            END IF;

    EXCEPTION WHEN
                NO_DATA_FOUND THEN
                K_CODERROR  :=14;
                K_DESCERROR := ' La oferta no le pertenece al cliente.';
                PCLUB.PKG_CC_MANTENIMIENTO.ADMPSI_OBTMENSAJE('REGOFERCANJEEERROR', K_RESP_SMS, V_RESPUESTA,V_DESERROR);
                RAISE EX_ERROR;
    END;

 ELSE

    IF V_TIPDOC = '2' THEN
        V_TIPDOC := 'DNI';
    ELSE
        V_TIPDOC := 'Carnet Extranjería';
    END IF;

    select COUNT(*) INTO V_CONTNOPRE
    from dm.ods_base_abonados@dbl_reptdm_d T
    WHERE T.TIPO_DOCUMENTO = V_TIPDOC
    AND T.NRO_DOCUMENTO = K_NUM_DOC
    AND T.IDSEGMENTO <> 1;

    select COUNT(*) INTO V_CONTPRE
    from dm.ods_base_abonados@dbl_reptdm_d T
    WHERE T.TIPO_DOCUMENTO = V_TIPDOC
    AND T.NRO_DOCUMENTO = K_NUM_DOC
    AND T.IDSEGMENTO = 1;

    IF V_CONTNOPRE = 0 THEN
        IF V_CONTPRE <> 0 THEN
             K_CODERROR  := 6;
             K_DESCERROR := 'El Nro de Dcto. ingresado no esta registrado  como cliente o se encuentra de BAJA. ';
             PCLUB.PKG_CC_MANTENIMIENTO.ADMPSI_OBTMENSAJE('REGCLIEPRENOVALIDO', K_RESP_SMS, V_RESPUESTA,V_DESERROR);
             K_RESP_SMS:= K_NUM_DOC || ' ' || K_RESP_SMS;
             RAISE EX_ERROR;
        END IF;
    END IF;

     K_CODERROR  := 6;
     K_DESCERROR := 'El Nro de Dcto. ingresado no esta registrado  como cliente o se encuentra de BAJA. ';
     PCLUB.PKG_CC_MANTENIMIENTO.ADMPSI_OBTMENSAJE('REGDOCNOVALIDO', K_RESP_SMS, V_RESPUESTA,V_DESERROR);
     K_RESP_SMS:= K_NUM_DOC || ' ' || K_RESP_SMS;
     RAISE EX_ERROR;
 END IF;


         INSERT INTO PCLUB.ADMPT_MOVIMIENTOCUPONERA VALUES(K_NUM_MOVIL,V_COD_CLI,V_NUM_OFER,V_COD_EST,'','E',
         V_COD_OFER,SYSDATE,V_COD_CUPONERA,V_COD_CUPON,K_USUARIO,SYSDATE,PCLUB.ADMPT_MOVIMIENTOCUP_SQ.NEXTVAL);

         UPDATE PCLUB.ADMPT_OFERTA O
         SET O.ADMPD_FEC_MOD=SYSDATE,
               O.ADMPV_USU_MOD=K_USUARIO,
               O.ADMPN_NRO_RED=CASE WHEN O.ADMPN_REDENCIONES IS NULL THEN  NVL(O.ADMPN_NRO_RED,0)+1
                                                ELSE NVL(O.ADMPN_NRO_RED,0)-1 END
         WHERE O.ADMPN_COD_OFERTA=V_COD_OFER;

         --IMPORTANTE : Para reportar en numero actual de utilizacion de las redenciones
         --si el campo OFERTA.ADMPN_REDENCIONES ES NULO  EL CAMPO ADMPN_NRO_RED ES EL NRO ACTUAL DE REDENCIONES UTILIZADAS
         --SINO FUESE ASI SERIA ADMPN_REDENCIONES - ADMPN_NRO_RED

         PCLUB.PKG_CC_MANTENIMIENTO.ADMPSI_OBTMENSAJE('REGOFERTAEXITO', K_RESP_SMS, V_RESPUESTA,V_DESERROR);

 COMMIT;
    /*JCGT FIN PARA CREAR EL MENSAJE*/

BEGIN
        SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
        FROM PCLUB.ADMPT_ERRORES_CC
        WHERE ADMPN_COD_ERROR=K_CODERROR;
EXCEPTION WHEN OTHERS THEN
    K_DESCERROR:='';
END;

EXCEPTION
    WHEN EX_ERROR THEN
        BEGIN
                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                FROM PCLUB.ADMPT_ERRORES_CC
                WHERE ADMPN_COD_ERROR=K_CODERROR;
        EXCEPTION WHEN OTHERS THEN
            K_DESCERROR:='';
        END;
    WHEN OTHERS THEN
            K_CODERROR  := 1;
            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);
END ADMPSI_MOVIMCUP;

PROCEDURE ADMPSI_CONCLIENTE(K_NUMDOC IN VARCHAR2,K_NOMCLI IN VARCHAR2,K_APECLI IN VARCHAR2,K_CUR_CLIE OUT SYS_REFCURSOR,K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS
EX_ERROR EXCEPTION;
V_SQL VARCHAR2(2000);
V_TIP_DOC VARCHAR2(10);
BEGIN
K_CODERROR:=0;
K_DESCERROR:=' ';

  IF K_NUMDOC IS NOT NULL THEN
    IF LENGTH(K_NUMDOC) = 8 THEN
      V_TIP_DOC := '2';
    ELSE
      V_TIP_DOC := '4';
    END IF;
  ELSE
    V_TIP_DOC := '';
  END IF;

OPEN K_CUR_CLIE FOR
    SELECT C.ADMPN_COD_CLI,
           C.ADMPV_NOM_CLI,
           C.ADMPV_APE_CLI,
           C.ADMPV_EMAIL,
           C.ADMPV_TIPO_DOC,
           TD.ADMPV_DSC_DOCUM,
           C.ADMPV_NUM_DOC,
           C.ADMPC_ESTADO,
           C.ADMPN_COD_SEG,
           S.ADMPV_DESCRIPCION
      FROM PCLUB.ADMPT_CLIENTECUPONERA  C,
           PCLUB.ADMPT_SEGMENTOCUPONERA S,
           PCLUB.ADMPT_TIPO_DOC         TD
     WHERE C.ADMPN_COD_SEG = S.ADMPN_COD_SEG
       AND C.ADMPV_TIPO_DOC = TD.ADMPV_COD_TPDOC
       AND (C.ADMPV_NUM_DOC = K_NUMDOC OR K_NUMDOC IS NULL)
       AND (C.ADMPV_NOM_CLI = K_NOMCLI OR K_NOMCLI IS NULL)
       AND (C.ADMPV_APE_CLI = K_APECLI OR K_APECLI IS NULL);

    BEGIN
            SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
            FROM PCLUB.ADMPT_ERRORES_CC
            WHERE ADMPN_COD_ERROR=K_CODERROR;
    EXCEPTION WHEN OTHERS THEN
                    K_DESCERROR:='ERROR';
    END;

EXCEPTION
    WHEN EX_ERROR THEN
        BEGIN
                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                FROM PCLUB.ADMPT_ERRORES_CC
                WHERE ADMPN_COD_ERROR=K_CODERROR;
        EXCEPTION WHEN OTHERS THEN
            K_DESCERROR:='';
        END;
    WHEN OTHERS THEN
            K_CODERROR  := 1;
            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);
END ADMPSI_CONCLIENTE;

PROCEDURE ADMPSS_LISTAMOVCUPONERA(K_IDCUPONERA   IN VARCHAR2,
                                  K_FECHAINI     IN date,
                                  K_FECHAFIN     IN date,
                                  CURSORCUPONERA OUT SYS_REFCURSOR,
                                  K_CODERROR     OUT NUMBER,
                                  K_DESCERROR    OUT VARCHAR2) IS

  P_TIPOCLIENTE VARCHAR(20);

BEGIN

  OPEN CURSORCUPONERA FOR
  --MOVIMIENTO
    SELECT CU.ADMPV_NOM_CUP    AS NOMCUP,
           MC.ADMPD_FEC_MOV    AS FECMOV,
           TD.ADMPV_DSC_DOCUM  AS TIPDOC,
           CC.ADMPV_NUM_DOC    AS NUMDOC,
           CC.ADMPV_NOM_CLI    AS NOMCLI,
           E.ADMPV_COD_ESTABL  AS CODEST,
           E.ADMPV_NOM_ESTABL  AS NOMEST,
           C.ADMPN_COD_CUPON   AS CODCUPON,
           C.ADMPV_DESC_CUPON  AS NOMCUPON,
           O.ADMPV_DESCRIPCION AS DESOFER
      FROM PCLUB.ADMPT_MOVIMIENTOCUPONERA MC
     INNER JOIN PCLUB.ADMPT_CUPONERA CU ON MC.ADMPN_COD_CUP = CU.ADMPN_COD_CUP
     INNER JOIN PCLUB.ADMPT_CLIENTECUPONERA CC ON MC.ADMPN_COD_CLI =
                                            CC.ADMPN_COD_CLI
     INNER JOIN PCLUB.ADMPT_TIPO_DOC TD ON CC.ADMPV_TIPO_DOC=TD.ADMPV_COD_TPDOC
     INNER JOIN PCLUB.ADMPT_ESTABLECIMIENTO E ON MC.ADMPV_COD_EST =
                                           E.ADMPV_COD_ESTABL
     INNER JOIN PCLUB.ADMPT_CUPON C ON MC.ADMPN_COD_CUPON = C.ADMPN_COD_CUPON
     INNER JOIN PCLUB.ADMPT_OFERTA O ON MC.ADMPV_COD_OFERTA = O.ADMPN_COD_OFERTA
     WHERE (MC.ADMPN_COD_CUP = K_IDCUPONERA or K_IDCUPONERA='-1')
       AND MC.ADMPD_FEC_MOV >= K_FECHAINI
       AND MC.ADMPD_FEC_MOV < K_FECHAFIN +1

     ORDER BY MC.ADMPV_NUM_MOVIL, MC.ADMPD_FEC_MOV;

  K_CODERROR := 0;

EXCEPTION
  WHEN OTHERS THEN
    K_CODERROR  := 1;
    K_DESCERROR := 'NO OK';

END ADMPSS_LISTAMOVCUPONERA;

PROCEDURE ADMPSI_ALTACLIENTE_MAN(K_TIPODOC IN VARCHAR2,K_NUMDOC IN VARCHAR2,K_NOMCLI IN VARCHAR2,K_APECLI IN VARCHAR2,K_EMAIL IN VARCHAR2,
                                                     K_COD_SEG IN NUMBER,K_ORIGEN  IN VARCHAR2,K_USUARIO IN VARCHAR2, K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS

V_CONT  NUMBER;
--V_COD_CLI VARCHAR2(40);
V_COD_SEG VARCHAR2(2);
EX_ERROR EXCEPTION;
BEGIN
 K_CODERROR  := 0;
 K_DESCERROR := '';

 IF K_TIPODOC IS NULL THEN
     K_CODERROR  := 4;
     K_DESCERROR := 'No ingresó el tipo de Dcto. ';
     RAISE EX_ERROR;
 END IF;

 IF K_NUMDOC IS NULL THEN
     K_CODERROR  := 4;
     K_DESCERROR := 'No ingresó el Nro de Dcto. ';
     RAISE EX_ERROR;
 END IF;

  IF K_COD_SEG IS NULL THEN
     K_CODERROR  := 4;
     K_DESCERROR := 'No ingresó el Cod. Segmento. ';
     RAISE EX_ERROR;
 END IF;

         SELECT COUNT(K_NUMDOC) INTO V_CONT
         FROM PCLUB.ADMPT_CLIENTECUPONERA C
         WHERE C.ADMPV_NUM_DOC = K_NUMDOC
         AND C.ADMPV_TIPO_DOC = K_TIPODOC
         AND C.ADMPC_ESTADO='A';

 IF V_CONT > 0 THEN
     K_CODERROR  := 4;
     K_DESCERROR := 'El cliente ya se encuentra registrado. ';
     RAISE EX_ERROR;
 END IF;



INSERT INTO PCLUB.ADMPT_CLIENTECUPONERA(ADMPN_COD_CLI,ADMPV_TIPO_DOC,ADMPV_NUM_DOC,ADMPV_NOM_CLI,ADMPV_APE_CLI,ADMPV_EMAIL,ADMPC_ESTADO,ADMPN_COD_SEG,ADMPD_FEC_REG,ADMPV_USU_REG,ADMPV_ESTADO_CON)
VALUES (PCLUB.ADMPT_CLIECUPONERA_SQ.NEXTVAL,K_TIPODOC,K_NUMDOC,K_NOMCLI,K_APECLI,K_EMAIL,'A',K_COD_SEG,SYSDATE,K_USUARIO,'A');

INSERT INTO PCLUB.ADMPT_CLIENTECUPONERALOG(ADMPV_TIPO_DOC,ADMPV_NUM_DOC,ADMPV_NOM_CLI,ADMPV_APE_CLI,ADMPV_EMAIL,ADMPC_ESTADO,ADMPD_FEC_REG,ADMPV_USU_REG,ADMPV_COD_SEG,ADMPV_ORIGEN,ADMPV_PROCESO)
VALUES(K_TIPODOC,K_NUMDOC,K_NOMCLI,K_APECLI,K_EMAIL,'R',SYSDATE,K_USUARIO,V_COD_SEG,K_ORIGEN,'A');

COMMIT;

BEGIN
        SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
        FROM PCLUB.ADMPT_ERRORES_CC
        WHERE ADMPN_COD_ERROR=K_CODERROR;
EXCEPTION WHEN OTHERS THEN
    K_DESCERROR:='';
END;

EXCEPTION
    WHEN EX_ERROR THEN

             INSERT INTO PCLUB.ADMPT_CLIENTECUPONERALOG(ADMPV_TIPO_DOC,ADMPV_NUM_DOC,ADMPV_NOM_CLI,ADMPV_APE_CLI,ADMPV_EMAIL,ADMPC_ESTADO,ADMPD_FEC_REG,ADMPV_USU_REG,ADMPV_COD_SEG,
             ADMPV_ORIGEN,ADMPV_DESC_ERROR,ADMPV_PROCESO) VALUES(K_TIPODOC,K_NUMDOC,K_NOMCLI,K_APECLI,K_EMAIL,'N',SYSDATE,K_USUARIO,V_COD_SEG,K_ORIGEN,K_DESCERROR,'A');
             COMMIT;
            BEGIN
                    SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                    FROM PCLUB.ADMPT_ERRORES_CC
                    WHERE ADMPN_COD_ERROR=K_CODERROR;
            EXCEPTION WHEN OTHERS THEN
                K_DESCERROR:='ERROR';
            END;

    WHEN OTHERS THEN

             K_CODERROR  := 1;
             K_DESCERROR :=SUBSTR(SQLERRM, 1, 250);
             INSERT INTO PCLUB.ADMPT_CLIENTECUPONERALOG(ADMPV_TIPO_DOC,ADMPV_NUM_DOC,ADMPV_NOM_CLI,ADMPV_APE_CLI,ADMPV_EMAIL,ADMPC_ESTADO,ADMPD_FEC_REG,ADMPV_USU_REG,ADMPV_COD_SEG,
             ADMPV_ORIGEN,ADMPV_DESC_ERROR,ADMPV_PROCESO) VALUES(K_TIPODOC,K_NUMDOC,K_NOMCLI,K_APECLI,K_EMAIL,'N',SYSDATE,K_USUARIO,V_COD_SEG,K_ORIGEN,K_DESCERROR,'A');
            COMMIT;
END ADMPSI_ALTACLIENTE_MAN;

PROCEDURE ADMPSI_ELIMINARCONSULTAS(K_FECHAINI IN DATE,K_CODERROR  OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS

EX_ERROR EXCEPTION;

BEGIN

 K_CODERROR:=0;
 K_DESCERROR:='';

DELETE PCLUB.ADMPT_CONSULTACUPONERA
WHERE ADMPD_FEC_REG<K_FECHAINI;

COMMIT;

EXCEPTION
    WHEN EX_ERROR THEN
        BEGIN
                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                FROM PCLUB.ADMPT_ERRORES_CC
                WHERE ADMPN_COD_ERROR=K_CODERROR;
        EXCEPTION WHEN OTHERS THEN
            K_DESCERROR:='';
        END;
    WHEN OTHERS THEN
            K_CODERROR  := 1;
            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);

END ADMPSI_ELIMINARCONSULTAS;

PROCEDURE ADMPSI_CAMBSEG_MASIVO(K_FECHA IN DATE,K_NOMARCH IN VARCHAR2,K_USUARIO IN VARCHAR2,K_NUMREGTOT OUT NUMBER,
                                                K_NUMREGPRO OUT NUMBER, K_NUMREGERR OUT NUMBER, K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS
 EX_ERROR EXCEPTION;

 TYPE REG IS RECORD(
  TIPO_DOC  VARCHAR2(20 BYTE),
  NUM_DOC   VARCHAR2(20 BYTE),
  SEG           VARCHAR2(2 BYTE),
  COD_SEG   NUMBER,
  NOM_ARCH   VARCHAR2(100 BYTE),
  FEC_PROC   DATE,
  SEQ            NUMBER,
  DES_ERROR  VARCHAR2(200 BYTE),
  COD_ERROR  NUMBER
);
vREGCLI REG;

 CURSOR ALTACLI IS
 SELECT * FROM PCLUB.ADMPT_TMP_CAMBIOSEG A
 WHERE A.ADMPD_FEC_PROC=K_FECHA
 AND A.ADMPV_NOM_ARCH=K_NOMARCH
 AND A.ADMPV_DES_ERROR IS NULL;

 V_REGCLI NUMBER;
 V_COUNT_CLI NUMBER;
 NUM_DOC_AUX NUMBER;

 V_CADENA VARCHAR2(42);
 V_REG_VALIDO CHAR(1);


 BEGIN
 K_CODERROR:=0;
 K_DESCERROR:=' ';
 V_REG_VALIDO:='V';

 UPDATE PCLUB.ADMPT_TMP_CAMBIOSEG A
 SET A.ADMPV_DES_ERROR='El tipo o Nro. de documento no es valido.',
       A.ADMPN_COD_ERROR=50
 WHERE (A.ADMPV_TIPO_DOC IS NULL OR A.ADMPV_NUM_DOC IS NULL)
 AND A.ADMPD_FEC_PROC=K_FECHA
 AND A.ADMPV_NOM_ARCH=K_NOMARCH
 AND A.ADMPV_DES_ERROR IS NULL;

UPDATE PCLUB.ADMPT_TMP_CAMBIOSEG A
 SET A.ADMPV_DES_ERROR='El tipo de documento no es aceptado.',
       A.ADMPN_COD_ERROR=51
 WHERE (A.ADMPV_TIPO_DOC <> '2' AND A.ADMPV_TIPO_DOC <> '4')
 AND A.ADMPD_FEC_PROC=K_FECHA
 AND A.ADMPV_NOM_ARCH=K_NOMARCH
 AND A.ADMPV_DES_ERROR IS NULL;

 UPDATE PCLUB.ADMPT_TMP_CAMBIOSEG A
 SET A.ADMPV_DES_ERROR='DNI no válido.',
       A.ADMPN_COD_ERROR=52
 WHERE (A.ADMPV_TIPO_DOC = '2' AND LENGTH(A.ADMPV_NUM_DOC) <> 8)  OR
       (A.ADMPV_TIPO_DOC = '4' AND LENGTH(A.ADMPV_NUM_DOC) > 10)
 AND A.ADMPD_FEC_PROC=K_FECHA
 AND A.ADMPV_NOM_ARCH=K_NOMARCH
 AND A.ADMPV_DES_ERROR IS NULL;

 UPDATE PCLUB.ADMPT_TMP_CAMBIOSEG A
 SET A.ADMPV_DES_ERROR='El Cod. de segmento es un dato obligatorio.',
       A.ADMPN_COD_ERROR=53
 WHERE A.ADMPV_SEG IS NULL
 AND A.ADMPD_FEC_PROC=K_FECHA
 AND A.ADMPV_NOM_ARCH=K_NOMARCH
 AND A.ADMPV_DES_ERROR IS NULL;

  UPDATE PCLUB.ADMPT_TMP_CAMBIOSEG A
 SET A.ADMPV_DES_ERROR='El cliente no se encuentra registrado.',
       A.ADMPN_COD_ERROR=54
 WHERE A.ADMPD_FEC_PROC=K_FECHA
 AND A.ADMPV_NOM_ARCH=K_NOMARCH
 AND A.ADMPV_DES_ERROR IS NULL
 AND NOT EXISTS (SELECT 1 FROM PCLUB.ADMPT_CLIENTECUPONERA C WHERE C.ADMPV_TIPO_DOC=A.ADMPV_TIPO_DOC AND C.ADMPV_NUM_DOC=A.ADMPV_NUM_DOC
                                                                                      AND C.ADMPC_ESTADO='A' );

  UPDATE PCLUB.ADMPT_TMP_CAMBIOSEG A
 SET A.ADMPV_DES_ERROR='El Cod. de segmento no existe.',
       A.ADMPN_COD_ERROR=55
 WHERE A.ADMPD_FEC_PROC=K_FECHA
 AND A.ADMPV_NOM_ARCH=K_NOMARCH
 AND A.ADMPV_DES_ERROR IS NULL
 AND NOT EXISTS (SELECT 1 FROM PCLUB.ADMPT_SEGMENTOCUPONERA S WHERE S.ADMPV_DESCRIPCION=A.ADMPV_SEG);

 UPDATE PCLUB.ADMPT_TMP_CAMBIOSEG A
    SET A.ADMPN_COD_SEG=(SELECT S.ADMPN_COD_SEG FROM PCLUB.ADMPT_SEGMENTOCUPONERA S WHERE S.ADMPV_DESCRIPCION =A.ADMPV_SEG)
 WHERE A.ADMPD_FEC_PROC=K_FECHA
 AND A.ADMPV_NOM_ARCH=K_NOMARCH
 AND A.ADMPV_DES_ERROR IS NULL;


 OPEN ALTACLI;
     FETCH ALTACLI INTO vREGCLI;

     WHILE ALTACLI%FOUND
       LOOP

        SELECT translate(vREGCLI.TIPO_DOC||vREGCLI.NUM_DOC||vREGCLI.SEG,'#$|~^¬´áéíóúñÁÉÍÓÚÑ','abcdefghijklmnopqrs')
             into V_CADENA FROM dual;

        IF vREGCLI.TIPO_DOC||vREGCLI.NUM_DOC||vREGCLI.SEG <> V_CADENA THEN
           V_REG_VALIDO:='F';
          UPDATE PCLUB.ADMPT_TMP_CAMBIOSEG A
                 SET A.ADMPV_DES_ERROR='El Registro contiene Caracteres No Permitidos',
                     A.ADMPN_COD_ERROR=50
          WHERE A.ADMPD_FEC_PROC=vREGCLI.FEC_PROC AND A.ADMPV_NOM_ARCH=vREGCLI.NOM_ARCH  AND
                A.ADMPV_DES_ERROR IS NULL AND A.ADMPV_TIPO_DOC = vREGCLI.TIPO_DOC AND
                A.ADMPV_NUM_DOC = vREGCLI.NUM_DOC AND A.ADMPV_SEG = vREGCLI.SEG;
        END IF;

          SELECT COUNT(*) INTO V_REGCLI
          FROM PCLUB.ADMPT_AUX_CAMBIOSEG T
          WHERE T.ADMPV_TIPO_DOC = vREGCLI.TIPO_DOC
          AND T.ADMPV_NUM_DOC = vREGCLI.NUM_DOC
          AND T.ADMPD_FEC_PROC = vREGCLI.FEC_PROC
          AND T.ADMPV_NOM_ARCH = vREGCLI.NOM_ARCH;

       IF V_REG_VALIDO= 'V' THEN
           IF V_REGCLI = 0 THEN
                NUM_DOC_AUX:=1;
                BEGIN
                    IF vREGCLI.TIPO_DOC='2' THEN
                        NUM_DOC_AUX:=TO_NUMBER(vREGCLI.NUM_DOC);
                    END IF;

                EXCEPTION WHEN OTHERS THEN
                     NUM_DOC_AUX:=0;
                END;

                IF NUM_DOC_AUX<>0 THEN
                    UPDATE PCLUB.ADMPT_CLIENTECUPONERA
                    SET ADMPN_COD_SEG = vREGCLI.COD_SEG,
                    ADMPV_USU_MOD=K_USUARIO,
                    ADMPD_FEC_MOD=SYSDATE
                    WHERE ADMPV_TIPO_DOC = vREGCLI.TIPO_DOC
                    AND ADMPV_NUM_DOC = vREGCLI.NUM_DOC
                    AND ADMPC_ESTADO='A';

                    INSERT INTO PCLUB.ADMPT_AUX_CAMBIOSEG VALUES(vREGCLI.TIPO_DOC,vREGCLI.NUM_DOC,vREGCLI.NOM_ARCH,vREGCLI.FEC_PROC,vREGCLI.SEQ);

                ELSE

                    UPDATE PCLUB.ADMPT_TMP_CAMBIOSEG T
                    SET T.ADMPV_DES_ERROR='DNI tiene formato no valido.',
                           T.ADMPN_COD_ERROR=100
                    WHERE T.ADMPV_TIPO_DOC = vREGCLI.TIPO_DOC
                    AND T.ADMPV_NUM_DOC = vREGCLI.NUM_DOC
                    AND T.ADMPD_FEC_PROC = vREGCLI.FEC_PROC
                    AND T.ADMPV_NOM_ARCH = vREGCLI.NOM_ARCH
                    AND T.ADMPN_SEQ = vREGCLI.SEQ;

                END IF;

           ELSE

                UPDATE PCLUB.ADMPT_TMP_CAMBIOSEG T
                SET T.ADMPV_DES_ERROR='El cliente ya fue procesado.',
                       T.ADMPN_COD_ERROR=101
                WHERE T.ADMPV_TIPO_DOC = vREGCLI.TIPO_DOC
                AND T.ADMPV_NUM_DOC = vREGCLI.NUM_DOC
                AND T.ADMPD_FEC_PROC = vREGCLI.FEC_PROC
                AND T.ADMPV_NOM_ARCH = vREGCLI.NOM_ARCH
                AND T.ADMPN_SEQ = vREGCLI.SEQ;

           END IF;
        END IF;
       V_REG_VALIDO:='V';
       FETCH ALTACLI INTO vREGCLI;
       END LOOP;

 INSERT INTO PCLUB.ADMPT_IMP_CAMBIOSEG
    SELECT  PCLUB.ADMPT_CAMBSEGMENTO_SQ.NEXTVAL , ADMPV_TIPO_DOC , ADMPV_NUM_DOC,
    ADMPV_SEG,ADMPN_COD_SEG, ADMPV_NOM_ARCH,ADMPD_FEC_PROC,ADMPN_SEQ,ADMPV_DES_ERROR,ADMPN_COD_ERROR
    FROM PCLUB.ADMPT_TMP_CAMBIOSEG
    WHERE ADMPD_FEC_PROC=K_FECHA
    AND ADMPV_NOM_ARCH = K_NOMARCH;

  -- Generar Resultados (Total registros, Total procesados, Total de errores)
    SELECT COUNT (1) INTO K_NUMREGTOT FROM PCLUB.ADMPT_TMP_CAMBIOSEG WHERE ADMPD_FEC_PROC=K_FECHA AND ADMPV_NOM_ARCH = K_NOMARCH;
    SELECT COUNT (1) INTO K_NUMREGERR FROM PCLUB.ADMPT_TMP_CAMBIOSEG WHERE ADMPD_FEC_PROC=K_FECHA AND ADMPV_NOM_ARCH = K_NOMARCH AND (ADMPV_DES_ERROR IS NOT NULL);
    SELECT COUNT (1) INTO K_NUMREGPRO FROM PCLUB.ADMPT_AUX_CAMBIOSEG WHERE ADMPD_FEC_PROC=K_FECHA AND ADMPV_NOM_ARCH = K_NOMARCH;

   -- Eliminamos los registros de la tabla temporal y auxiliar
   DELETE PCLUB.ADMPT_AUX_CAMBIOSEG WHERE ADMPD_FEC_PROC=K_FECHA AND ADMPV_NOM_ARCH = K_NOMARCH;
   DELETE PCLUB.ADMPT_TMP_CAMBIOSEG WHERE ADMPD_FEC_PROC=K_FECHA AND ADMPV_NOM_ARCH = K_NOMARCH;



 COMMIT;

     BEGIN
            SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
            FROM PCLUB.ADMPT_ERRORES_CC
            WHERE ADMPN_COD_ERROR=K_CODERROR;
    EXCEPTION WHEN OTHERS THEN
                    K_DESCERROR:='ERROR';
    END;

EXCEPTION
    WHEN EX_ERROR THEN
        BEGIN
                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                FROM PCLUB.ADMPT_ERRORES_CC
                WHERE ADMPN_COD_ERROR=K_CODERROR;
        EXCEPTION WHEN OTHERS THEN
            K_DESCERROR:='';
        END;
    WHEN OTHERS THEN
            K_CODERROR  := 1;
            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);
 END ADMPSI_CAMBSEG_MASIVO;


 PROCEDURE ADMPSI_ECAMBSEG_MASIVO(K_FECHA IN DATE,K_NOMARCH IN VARCHAR2,K_CUR_CUP OUT SYS_REFCURSOR,K_CODERROR OUT NUMBER,K_DESCERROR OUT VARCHAR2) IS
 EX_ERROR EXCEPTION;

 BEGIN
 K_CODERROR:=0;
 K_DESCERROR:=' ';

 OPEN K_CUR_CUP FOR
 SELECT ADMPV_TIPO_DOC,ADMPV_NUM_DOC,ADMPV_SEG,ADMPV_DES_ERROR
FROM PCLUB.ADMPT_IMP_CAMBIOSEG
WHERE ADMPD_FEC_PROC=K_FECHA
AND ADMPV_NOM_ARCH=K_NOMARCH
AND (ADMPV_DES_ERROR IS NOT NULL);

     BEGIN
            SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
            FROM PCLUB.ADMPT_ERRORES_CC
            WHERE ADMPN_COD_ERROR=K_CODERROR;
    EXCEPTION WHEN OTHERS THEN
                    K_DESCERROR:='ERROR';
    END;

EXCEPTION
    WHEN EX_ERROR THEN
        BEGIN
                SELECT ADMPV_DES_ERROR || K_DESCERROR INTO K_DESCERROR
                FROM PCLUB.ADMPT_ERRORES_CC
                WHERE ADMPN_COD_ERROR=K_CODERROR;
        EXCEPTION WHEN OTHERS THEN
            K_DESCERROR:='';
        END;
    WHEN OTHERS THEN
            K_CODERROR  := 1;
            K_DESCERROR := SUBSTR(SQLERRM, 1, 250);
 END ADMPSI_ECAMBSEG_MASIVO;


END PKG_CC_CUPONERA;
/
