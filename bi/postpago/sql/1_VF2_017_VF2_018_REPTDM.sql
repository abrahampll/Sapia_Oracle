WHENEVER SQLERROR EXIT 1;

SET ECHO ON;
SET SERVEROUTPUT ON;
SET TIMING ON;

WHENEVER SQLERROR EXIT 1;



DECLARE
V_PERIODO  VARCHAR2(6);
V_QUERY    VARCHAR2(30000);
v_MsgError VARCHAR2(130);
LD_FECINI  DATE;
LD_FECFIN  DATE;
V_DIA_SMES VARCHAR2(10);
V_COUNT    NUMBER;
V_DIA      VARCHAR2(8);
i          NUMBER;
x          NUMBER;
y          NUMBER;
BEGIN
SELECT '&1' INTO V_PERIODO FROM DUAL;
Execute Immediate 'ALTER SESSION SET NLS_DATE_FORMAT=''DD/MM/RR''';
LD_FECINI := TO_DATE(V_PERIODO, 'YYYYMM');  
SELECT LAST_DAY(LD_FECINI) INTO LD_FECFIN FROM DUAL;
WHILE LD_FECINI <= LD_FECFIN LOOP
V_DIA := TO_CHAR(LD_FECINI, 'yyyymmdd');
V_QUERY := '';
V_QUERY := 'CREATE TABLE DM.DW_TEMPORAL nologging PARALLEL 100  AS ' ||
'SELECT TIM_NUMBER, ' || V_DIA ||' fecha, ' ||
' SUM(CASE WHEN LENGTH(NUMBER_B)= 11 AND A.NUMBER_B LIKE ''519%'' AND RN_ORI IN (''24'',''20'',''22'',''32'',''25'') AND A.RECORD_TYPE = ''02''  THEN 1 ELSE 0 END)  VF2_263, ' ||   
' SUM(CASE WHEN LENGTH(NUMBER_B)= 11 AND A.NUMBER_B LIKE ''519%'' AND RN_ORI=''24'' AND A.RECORD_TYPE = ''02''  THEN 1 ELSE 0 END)  VF2_264, ' ||
' SUM(CASE WHEN LENGTH(NUMBER_B)= 11 AND A.NUMBER_B LIKE ''519%'' AND RN_ORI=''20'' AND A.RECORD_TYPE = ''02''  THEN 1 ELSE 0 END)  VF2_265, ' ||
' SUM(CASE WHEN LENGTH(NUMBER_B)= 11 AND A.NUMBER_B LIKE ''519%'' AND RN_ORI IN (''22'',''32'') AND A.RECORD_TYPE = ''02''  THEN 1 ELSE 0 END)  VF2_266, ' ||
' SUM(CASE WHEN LENGTH(NUMBER_B)= 11 AND A.NUMBER_B LIKE ''519%'' AND RN_ORI=''25'' AND A.RECORD_TYPE = ''02''  THEN 1 ELSE 0 END)  VF2_267, ' ||
' SUM(CASE WHEN LENGTH(NUMBER_B)= 11 AND A.NUMBER_B LIKE ''519%'' AND RN_ORI NOT IN (''24'',''20'',''22'',''32'',''25'',''21'') AND A.RECORD_TYPE = ''02''  THEN 1 ELSE 0 END)  VF2_268, ' ||                          
' SUM(CASE WHEN LENGTH(NUMBER_B)= 10 AND A.NUMBER_B LIKE ''51%'' AND RN_ORI=''20'' AND A.RECORD_TYPE = ''02''  THEN 1 ELSE 0 END)  VF2_269, ' ||
' SUM(CASE WHEN LENGTH(NUMBER_B)= 10 AND A.NUMBER_B LIKE ''51%'' AND RN_ORI IN (''22'',''32'') AND A.RECORD_TYPE = ''02''  THEN 1 ELSE 0 END)  VF2_270, ' ||
' SUM(CASE WHEN LENGTH(NUMBER_B)= 11 AND A.NUMBER_B LIKE ''519%'' AND RN_ORI IN (''24'',''20'',''22'',''32'',''25'') AND A.RECORD_TYPE = ''02''  THEN to_number(CALL_DURATION) ELSE 0 END)  VF2_271, ' ||         
' SUM(CASE WHEN LENGTH(NUMBER_B)= 11 AND A.NUMBER_B LIKE ''519%'' AND RN_ORI=''24'' AND A.RECORD_TYPE = ''02''  THEN to_number(CALL_DURATION) ELSE 0 END)  VF2_272, ' ||
' SUM(CASE WHEN LENGTH(NUMBER_B)= 11 AND A.NUMBER_B LIKE ''519%'' AND RN_ORI=''20'' AND A.RECORD_TYPE = ''02''  THEN to_number(CALL_DURATION) ELSE 0 END)  VF2_273, ' ||
' SUM(CASE WHEN LENGTH(NUMBER_B)= 11 AND A.NUMBER_B LIKE ''519%'' AND RN_ORI IN (''22'',''32'') AND A.RECORD_TYPE = ''02''  THEN to_number(CALL_DURATION) ELSE 0 END)  VF2_274, ' ||
' SUM(CASE WHEN LENGTH(NUMBER_B)= 11 AND A.NUMBER_B LIKE ''519%'' AND RN_ORI=''25'' AND A.RECORD_TYPE = ''02''  THEN to_number(CALL_DURATION) ELSE 0 END)  VF2_275, ' ||       
' SUM(CASE WHEN LENGTH(NUMBER_B)= 11 AND A.NUMBER_B LIKE ''519%'' AND RN_ORI NOT IN (''24'',''20'',''22'',''32'',''25'',''21'') AND A.RECORD_TYPE = ''02''  THEN to_number(CALL_DURATION) ELSE 0 END)  VF2_276, ' ||                           
' SUM(CASE WHEN LENGTH(NUMBER_B)= 10 AND A.NUMBER_B LIKE ''51%'' AND RN_ORI=''20'' AND A.RECORD_TYPE = ''02''  THEN to_number(CALL_DURATION) ELSE 0 END)  VF2_277, ' ||
' SUM(CASE WHEN LENGTH(NUMBER_B)= 10 AND A.NUMBER_B LIKE ''51%'' AND RN_ORI IN (''22'',''32'') AND A.RECORD_TYPE = ''02''  THEN to_number(CALL_DURATION) ELSE 0 END)  VF2_278,  ' || 
' SUM(CASE WHEN LENGTH(NUMBER_B)= 11 AND A.NUMBER_B LIKE ''519%'' AND RN_ORI=''21'' AND A.RECORD_TYPE = ''02''  THEN 1 ELSE 0 END)  VF2_279, ' ||   
' SUM(CASE WHEN LENGTH(NUMBER_B)= 10 AND A.NUMBER_B LIKE ''51%'' AND RN_ORI IN (''21'',''23'') AND A.RECORD_TYPE = ''02''  THEN 1 ELSE 0 END)  VF2_280, ' ||      
' SUM(CASE WHEN LENGTH(NUMBER_B)= 11 AND A.NUMBER_B LIKE ''519%'' AND RN_ORI=''21'' AND A.RECORD_TYPE = ''02''  THEN to_number(CALL_DURATION) ELSE 0 END)  VF2_281, ' ||   
' SUM(CASE WHEN LENGTH(NUMBER_B)= 10 AND A.NUMBER_B LIKE ''51%''  AND RN_ORI IN (''21'',''23'') AND A.RECORD_TYPE = ''02''  THEN to_number(CALL_DURATION) ELSE 0 END)  VF2_282, ' ||               
' sum(CASE WHEN LENGTH(NUMBER_B)>= 10 AND A.RECORD_TYPE = ''01'' AND A.FACILITY_USAGE=''2G'' THEN to_number(CALL_DURATION) ELSE 0 END) VF2_084, ' ||
' sum(CASE WHEN LENGTH(NUMBER_B)>= 10 AND A.RECORD_TYPE = ''01'' AND A.FACILITY_USAGE=''3G'' THEN to_number(CALL_DURATION) ELSE 0 END) VF2_085, ' ||    
' SUM(CASE WHEN LENGTH(NUMBER_B)= 11 AND A.NUMBER_B LIKE ''519%'' AND CAUSE_FOR_TERMINATION=''00000000'' AND RN_ORI=''24'' AND A.RECORD_TYPE = ''09''  THEN 1 ELSE 0 END)  VF2_257, ' ||
' SUM(CASE WHEN LENGTH(NUMBER_B)= 11 AND A.NUMBER_B LIKE ''519%'' AND CAUSE_FOR_TERMINATION=''00000000'' AND RN_ORI=''20'' AND A.RECORD_TYPE = ''09''  THEN 1 ELSE 0 END)  VF2_258, ' ||
' SUM(CASE WHEN LENGTH(NUMBER_B)= 11 AND A.NUMBER_B LIKE ''519%'' AND CAUSE_FOR_TERMINATION=''00000000'' AND RN_ORI IN (''22'',''32'') AND A.RECORD_TYPE = ''09''  THEN 1 ELSE 0 END)  VF2_259, ' ||
' SUM(CASE WHEN LENGTH(NUMBER_B)= 11 AND A.NUMBER_B LIKE ''519%'' AND CAUSE_FOR_TERMINATION=''00000000'' AND RN_ORI=''25'' AND A.RECORD_TYPE = ''09''  THEN 1 ELSE 0 END)  VF2_260, ' ||
' SUM(CASE WHEN LENGTH(NUMBER_B)= 11 AND A.NUMBER_B LIKE ''519%'' AND CAUSE_FOR_TERMINATION=''00000000'' AND  A.RECORD_TYPE = ''09''  THEN 1 ELSE 0 END)  VF2_261, ' ||        
' SUM(CASE WHEN A.RECORD_TYPE = ''01'' and (dialled_digits=''123'' or dialled_digits=''135'')  THEN 1 ELSE 0 END) as vf2_017, '|| 
' sum(CASE WHEN A.RECORD_TYPE = ''01'' and (dialled_digits=''123'' or dialled_digits=''135'') THEN to_number(CALL_DURATION) ELSE 0 END) as vf2_018, '|| 
' sum(CASE WHEN A.RECORD_TYPE = ''09'' and number_b=''131'' THEN 1 ELSE 0 END) as vf2_229, '||
' sum(case when CDR_SOURCE = ''N'' and RECORD_TYPE = ''02'' and a.operador_b is null and zona_ope_b is null and codigodepais is not null and '||
' number_b not in (''5121914000'',''5121988001'', ''5121914500'',''5121994200'',''5121994300'',''5121922001'',''51998251574'',''51998252047'') '||
' then NVL(to_number(CALL_DURATION), 0) else  0 end) VF2_286, '||
' sum(case when CDR_SOURCE = ''N'' and RECORD_TYPE = ''02'' and a.operador_b is null and zona_ope_b is null and codigodepais is not null and  '|| 
' number_b not in (''5121914000'',''5121988001'', ''5121914500'',''5121994200'',''5121994300'',''5121922001'',''51998251574'',''51998252047'') '||
' then 1 else  0 end) VF2_283,  '||
' SUM(CASE WHEN  A.NUMBER_B LIKE ''51%'' AND  A.RECORD_TYPE = ''01''  THEN 1 ELSE 0 END)  VF2_440, ' ||    
' SUM(CASE WHEN  A.NUMBER_B LIKE ''51%'' AND  A.RECORD_TYPE = ''08''  THEN 1 ELSE 0 END)  VF2_439 ' ||     
' FROM  DM.CDR_DWH PARTITION (CDR_DWH_'||V_DIA||') A ' ||
' WHERE EXISTS (SELECT 1 FROM DM.DW_Maestra_Postpago B  where b.msisdn=a.tim_number) AND CALL_DURATION>0 ' ||       
' GROUP BY A.TIM_NUMBER' ;   
EXECUTE IMMEDIATE V_QUERY;
V_QUERY:='';
v_query:='INSERT INTO  DM.DW_TEMPORAL_DIA (tim_number,fecha, VF2_263,VF2_264,VF2_265,VF2_266,VF2_267,VF2_268,VF2_269,VF2_270,VF2_271,VF2_272,' ||
'VF2_273,VF2_274,VF2_275,VF2_276,VF2_277,VF2_278,VF2_279, ' ||
'VF2_280,VF2_281,VF2_282,VF2_084,VF2_085,VF2_257,VF2_258,VF2_259,VF2_260,VF2_261, vf2_017, vf2_018, vf2_229, VF2_286, VF2_283, VF2_439, VF2_440) ' || 
'SELECT tim_number,fecha, VF2_263,VF2_264,VF2_265,VF2_266,VF2_267,VF2_268,VF2_269,VF2_270,VF2_271,VF2_272,' ||
'VF2_273,VF2_274,VF2_275,VF2_276,VF2_277,VF2_278,VF2_279, ' ||
'VF2_280,VF2_281,VF2_282,VF2_084,VF2_085,VF2_257,VF2_258,VF2_259,VF2_260,VF2_261, vf2_017, vf2_018, vf2_229, VF2_286, VF2_283,VF2_439, VF2_440  ' ||
'FROM DM.DW_TEMPORAL';
EXECUTE IMMEDIATE V_QUERY;
COMMIT;
V_QUERY:='';
v_query:='truncate table DM.DW_TEMPORAL drop all storage';
EXECUTE IMMEDIATE V_QUERY;
V_QUERY:='';
v_query:='drop table DM.DW_TEMPORAL purge';
EXECUTE IMMEDIATE V_QUERY;                
LD_FECINI := LD_FECINI + 1;
END LOOP;
V_QUERY:='';
v_query:='INSERT INTO  DM.DW_SPSS2_CURSADO (tim_number,periodo,vf2_263,vf2_264,vf2_265, '||
'vf2_266,vf2_267,vf2_268,vf2_269,vf2_270,vf2_271,vf2_272,vf2_273,vf2_274,vf2_275,vf2_276,vf2_277,vf2_278,vf2_279,vf2_280,vf2_281, '||
'vf2_282,vf2_084,vf2_085,vf2_257,vf2_258,vf2_259,vf2_260,vf2_261,vf2_017,vf2_018,vf2_229,vf2_286,vf2_283,vf2_437,vf2_435, VF2_439, VF2_440) ' ||
'  SELECT tim_number,'||V_PERIODO||' AS PERIODO, SUM(VF2_263) as vf2_263,SUM(VF2_264) AS VF2_264,SUM(VF2_265) AS VF2_265,SUM(VF2_266) AS VF2_266,SUM(VF2_267) AS VF2_267,SUM(VF2_268) AS VF2_268,SUM(VF2_269) AS VF2_269,sUM(VF2_270) AS VF2_270,round(sum(VF2_271)/60,2) AS VF2_271,round(sum(VF2_272)/60,2) AS VF2_272, ' ||
'  round(sum(VF2_273)/60,2) AS VF2_273,round(sum(VF2_274)/60,2) AS VF2_274,round(sum(VF2_275)/60,2) AS VF2_275,round(sum(VF2_276)/60,2) AS VF2_276,round(sum(VF2_277)/60,2) AS VF2_277,round(sum(VF2_278)/60,2)AS VF2_278,SUM(VF2_279) AS VF2_279, ' ||
'  SUM(VF2_280) AS VF2_280,round(sum(VF2_281)/60,2) AS VF2_281,round(sum(VF2_282)/60,2) AS VF2_282, round(sum(VF2_084)/60,2) AS VF2_084,round(sum(VF2_085)/60,2) AS VF2_085,SUM(VF2_257) AS VF2_257,SUM(VF2_258) AS VF2_258,SUM(VF2_259) AS VF2_259,SUM(VF2_260) AS VF2_260,SUM(VF2_261) AS VF2_261, ' ||
'  SUM(vf2_017) AS VF2_017,ROUND(SUM(vf2_018)/60,2) AS VF2_018, SUM(vf2_229) AS VF2_229, ROUND(sUM(VF2_286)/60,2) AS VF2_286, SUM(VF2_283) AS VF2_283, '||
'  SUM(CASE WHEN (VF2_257+VF2_258+VF2_259+VF2_260+VF2_261)>0 THEN 1 ELSE 0 END) as VF2_437, '||
'  SUM(CASE WHEN (VF2_263+VF2_264+VF2_265+VF2_266+VF2_267+VF2_268+VF2_269+VF2_270+VF2_271+VF2_272+VF2_273+VF2_274+VF2_275+VF2_276+VF2_277+VF2_278+VF2_279+VF2_280+VF2_281+VF2_282+VF2_084+VF2_085)>0 THEN 1 ELSE 0 END) as VF2_435, '||
'  SUM(CASE WHEN VF2_439 >0 THEN 1 ELSE 0 END) as VF2_439, '||
'  SUM(CASE WHEN VF2_440 >0 THEN 1 ELSE 0 END) as VF2_440 '||
'  FROM DM.DW_TEMPORAL_DIA GROUP BY TIM_NUMBER' ;
EXECUTE IMMEDIATE V_QUERY;
COMMIT;
V_QUERY:='';
V_QUERY:='TRUNCATE TABLE DM.DW_TEMPORAL_DIA DROP ALL STORAGE';
EXECUTE IMMEDIATE V_QUERY;
EXCEPTION
WHEN NO_DATA_FOUND THEN
v_MsgError := 'Proceso no se ejecuto correctamente.';
DBMS_OUTPUT.PUT_LINE(v_MsgError);
WHEN OTHERS THEN
v_MsgError := 'Error ' || 'ORA' || SqlCode || ' ' || substr(SQLERRM, 1, 100);
DBMS_OUTPUT.PUT_LINE(v_MsgError);
END;
/


EXIT;
